{
  "spec_id": "001-rag-memory-integration",
  "spec_name": "Full RAG Memory Integration",
  "created_at": "2025-02-03T00:00:00Z",
  "phases": [
    {
      "id": "phase-1",
      "name": "Memory HTTP Clients",
      "description": "Create HTTP client modules for LightRAG and Memory Service APIs",
      "subtasks": [
        {
          "id": "1.1",
          "title": "Create LightRAG HTTP client",
          "description": "Create src/memory/lightrag-client.ts with query, getEntities, and getStats methods following the pattern established by other memory modules. Client should include health check, error handling, and timeout support.",
          "status": "completed",
          "files_to_create": [
            "src/memory/lightrag-client.ts"
          ],
          "files_to_reference": [
            "src/memory/embeddings-openai.ts",
            "src/memory/manager.ts"
          ],
          "acceptance_criteria": [
            "POST /query with mode parameter (naive/local/global/hybrid)",
            "GET /graph/entities for entity listing",
            "GET /stats for knowledge base statistics",
            "Configurable endpoint URL and timeout",
            "Graceful error handling with typed responses"
          ],
          "notes": "LightRAG HTTP client successfully created with all required methods: query (POST /query with mode parameter), getEntities (GET /graph/entities), getStats (GET /stats), and health check. Includes proper error handling, timeout support with AbortController, typed responses, and configurable endpoint/timeout options. File already committed.",
          "updated_at": "2026-02-03T16:33:54.124562+00:00"
        },
        {
          "id": "1.2",
          "title": "Create Memory Service HTTP client",
          "description": "Create src/memory/memory-service-client.ts with search, listEntities, and health methods. Follow same patterns as LightRAG client.",
          "status": "completed",
          "files_to_create": [
            "src/memory/memory-service-client.ts"
          ],
          "files_to_reference": [
            "src/memory/lightrag-client.ts"
          ],
          "acceptance_criteria": [
            "GET /memories/search with query and limit parameters",
            "GET /entities for entity listing",
            "GET /health for health checks",
            "Configurable endpoint URL and timeout",
            "Graceful error handling with typed responses"
          ],
          "notes": "Memory Service HTTP client successfully created with all required methods: search (GET /memories/search with query and limit parameters), listEntities (GET /entities), and health check (GET /health). Includes proper error handling, timeout support with AbortController, typed responses, and configurable endpoint/timeout options. Follows the same pattern as lightrag-client.ts. File committed successfully.",
          "updated_at": "2026-02-03T16:38:35.173802+00:00"
        },
        {
          "id": "1.3",
          "title": "Create Graphiti HTTP client",
          "description": "Create src/memory/graphiti-client.ts with search, getGraph, getEntity, and getTimeline methods. This client will be used by the graphiti_search tool.",
          "status": "completed",
          "files_to_create": [
            "src/memory/graphiti-client.ts"
          ],
          "files_to_reference": [
            "src/memory/lightrag-client.ts"
          ],
          "acceptance_criteria": [
            "GET /entities/search with natural language query",
            "GET /graph for point-in-time graph retrieval",
            "GET /entities/{id} for entity details",
            "GET /timeline for stats and temporal bounds",
            "Configurable endpoint URL and timeout"
          ],
          "notes": "Graphiti HTTP client successfully created with all required methods: search (GET /entities/search with natural language query, entity types, and time range filters), getGraph (GET /graph for point-in-time graph retrieval with timestamp, entity IDs, and depth parameters), getEntity (GET /entities/{id} for entity details with neighbors and relationships), getTimeline (GET /timeline for stats and temporal bounds), and health check. Includes proper error handling, timeout support with AbortController, typed responses, and configurable endpoint/timeout options. Follows the same pattern as lightrag-client.ts and memory-service-client.ts. File compiled successfully and committed.",
          "updated_at": "2026-02-03T16:43:32.220615+00:00"
        }
      ]
    },
    {
      "id": "phase-2",
      "name": "RAG Configuration Types",
      "description": "Extend configuration schema to support all three RAG service endpoints",
      "subtasks": [
        {
          "id": "2.1",
          "title": "Define RAG service config types",
          "description": "Create src/config/types.rag.ts with RAGServiceConfig, GraphitiConfig, LightRAGConfig, and MemoryServiceConfig types.",
          "status": "completed",
          "files_to_create": [
            "src/config/types.rag.ts"
          ],
          "files_to_reference": [
            "src/config/types.tools.ts",
            "src/config/types.agent-defaults.ts"
          ],
          "acceptance_criteria": [
            "GraphitiConfig with enabled, endpoint fields",
            "LightRAGConfig with enabled, endpoint fields",
            "MemoryServiceConfig with enabled, endpoint fields",
            "RAGSearchConfig combining all three services",
            "Hook config for rag-context-inject"
          ],
          "notes": "Successfully created src/config/types.rag.ts with all required RAG configuration types: GraphitiConfig, LightRAGConfig, MemoryServiceConfig, RAGServiceConfig, and RAGContextInjectHookConfig. Each config type includes enabled flag, endpoint URL, timeout settings, and service-specific options. The types follow the existing patterns from types.tools.ts and types.agent-defaults.ts. File committed successfully.",
          "updated_at": "2026-02-03T17:03:50.955620+00:00"
        },
        {
          "id": "2.2",
          "title": "Extend MemorySearchConfig with RAG options",
          "description": "Update src/config/types.tools.ts to add graphiti, lightrag, and memoryService options under MemorySearchConfig or add a separate ragSearch config.",
          "status": "completed",
          "files_to_modify": [
            "src/config/types.tools.ts"
          ],
          "files_to_reference": [
            "src/config/types.rag.ts"
          ],
          "acceptance_criteria": [
            "MemorySearchConfig extended with RAG service options",
            "Each service has enabled and endpoint fields",
            "Types are properly exported"
          ],
          "notes": "Successfully extended MemorySearchConfig in src/config/types.tools.ts with RAG service options. Added imports for GraphitiConfig, LightRAGConfig, and MemoryServiceConfig from types.rag.ts. Each RAG service (graphiti, lightrag, memoryService) is now available as an optional field in MemorySearchConfig with enabled flags, endpoint URLs, and timeout configuration. Changes compile without errors and follow existing patterns. Committed successfully.",
          "updated_at": "2026-02-03T17:10:03.198690+00:00"
        },
        {
          "id": "2.3",
          "title": "Add Zod schema for RAG config validation",
          "description": "Update the Zod schema files to validate RAG configuration options.",
          "status": "completed",
          "files_to_modify": [
            "src/config/zod-schema.core.ts"
          ],
          "files_to_reference": [
            "src/config/types.rag.ts"
          ],
          "acceptance_criteria": [
            "Zod schema validates graphiti config",
            "Zod schema validates lightrag config",
            "Zod schema validates memoryService config",
            "Schema integrates with existing config validation"
          ],
          "notes": "Successfully added Zod validation schemas for all RAG configuration types to src/config/zod-schema.core.ts:\n- LightRAGModeSchema: Enum for query modes (naive/local/global/hybrid)\n- GraphitiConfigSchema: Validates enabled flag, endpoint URL, and timeout\n- LightRAGConfigSchema: Includes defaultMode in addition to base config\n- MemoryServiceConfigSchema: Validates Memory Service configuration\n- RAGServiceConfigSchema: Combined schema for all three RAG services\n- RAGContextInjectHookConfigSchema: Validates hook config with maxEntities, maxRelations, maxMemories, maxDocuments\n\nAll schemas follow existing patterns with .strict() and .optional() modifiers, proper integer validation with .int().positive() where appropriate. The schemas align perfectly with the TypeScript types defined in src/config/types.rag.ts. Changes committed successfully.",
          "updated_at": "2026-02-03T17:57:32.859802+00:00"
        }
      ]
    },
    {
      "id": "phase-3",
      "name": "RAG Query Tools",
      "description": "Create agent-accessible tools for querying RAG services",
      "subtasks": [
        {
          "id": "3.1",
          "title": "Create graphiti_search tool",
          "description": "Create src/agents/tools/graphiti-search-tool.ts implementing the graphiti_search tool. Uses the Graphiti client to search entities and relationships.",
          "status": "completed",
          "files_to_create": [
            "src/agents/tools/graphiti-search-tool.ts"
          ],
          "files_to_reference": [
            "src/agents/tools/memory-tool.ts",
            "src/memory/graphiti-client.ts"
          ],
          "acceptance_criteria": [
            "Tool schema with query, entityTypes, timeRange, limit parameters",
            "Uses GraphitiClient for API calls",
            "Returns entities, relationships, and context",
            "Graceful degradation if service unavailable",
            "Health check before querying"
          ],
          "notes": "Successfully created src/agents/tools/graphiti-search-tool.ts implementing the graphiti_search tool. The tool:\n- Uses GraphitiClient to search entities and relationships in the temporal knowledge graph\n- Supports query, entityTypes, timeRange, and limit parameters via TypeBox schema\n- Performs health check before querying and returns graceful error responses\n- Returns entities, relationships, and total count\n- Follows established patterns from memory-tool.ts\n- Accesses graphiti config from memorySearch (defaults + agent overrides)\n- Uses proper defaults from graphiti-client constants\n- File successfully committed with descriptive message",
          "updated_at": "2026-02-03T18:03:26.852946+00:00"
        },
        {
          "id": "3.2",
          "title": "Create lightrag_query tool",
          "description": "Create src/agents/tools/lightrag-query-tool.ts implementing the lightrag_query tool. Uses the LightRAG client for hybrid document search.",
          "status": "completed",
          "files_to_create": [
            "src/agents/tools/lightrag-query-tool.ts"
          ],
          "files_to_reference": [
            "src/agents/tools/memory-tool.ts",
            "src/memory/lightrag-client.ts"
          ],
          "acceptance_criteria": [
            "Tool schema with query, mode, topK, includeSources parameters",
            "Uses LightRAGClient for API calls",
            "Returns answer, sources, entities, confidence",
            "Graceful degradation if service unavailable",
            "Health check before querying"
          ],
          "notes": "Successfully created src/agents/tools/lightrag-query-tool.ts implementing the lightrag_query tool. The tool:\n- Uses LightRAGClient to query the long-term document knowledge base\n- Supports query, mode, topK, and includeSources parameters via TypeBox schema\n- Performs health check before querying and returns graceful error responses\n- Returns answer, sources, entities, and confidence\n- Follows established patterns from graphiti-search-tool.ts and memory-tool.ts\n- Accesses lightrag config from memorySearch (defaults + agent overrides)\n- Uses proper defaults from lightrag-client constants\n- File successfully committed with descriptive message (commit: 644052c4d)",
          "updated_at": "2026-02-03T18:17:37.688520+00:00"
        },
        {
          "id": "3.3",
          "title": "Create memory_service_query tool",
          "description": "Create src/agents/tools/memory-service-query-tool.ts implementing the memory_service_query tool. Uses the Memory Service client.",
          "status": "completed",
          "files_to_create": [
            "src/agents/tools/memory-service-query-tool.ts"
          ],
          "files_to_reference": [
            "src/agents/tools/memory-tool.ts",
            "src/memory/memory-service-client.ts"
          ],
          "acceptance_criteria": [
            "Tool schema with query, limit parameters",
            "Uses MemoryServiceClient for API calls",
            "Returns memories and entities",
            "Graceful degradation if service unavailable",
            "Health check before querying"
          ],
          "notes": "Memory Service query tool successfully created following the established pattern from graphiti-search-tool and lightrag-query-tool. Implements the tool schema with query and limit parameters, uses MemoryServiceClient for API calls, includes health check for graceful degradation, and returns memories array with scores and metadata. File compiled and committed successfully.",
          "updated_at": "2026-02-03T18:23:02.601030+00:00"
        },
        {
          "id": "3.4",
          "title": "Register RAG tools in openclaw-tools.ts",
          "description": "Update src/agents/openclaw-tools.ts to create and include the RAG query tools when configured.",
          "status": "completed",
          "files_to_modify": [
            "src/agents/openclaw-tools.ts"
          ],
          "files_to_reference": [
            "src/agents/tools/graphiti-search-tool.ts",
            "src/agents/tools/lightrag-query-tool.ts",
            "src/agents/tools/memory-service-query-tool.ts"
          ],
          "acceptance_criteria": [
            "Import all three RAG tool creators",
            "Conditionally create tools based on config",
            "Tools appear in agent tool list when enabled"
          ],
          "notes": "Successfully registered all three RAG query tools in openclaw-tools.ts. The implementation:\n- Imports createGraphitiSearchTool, createLightRAGQueryTool, and createMemoryServiceQueryTool\n- Creates tool instances with config and agentSessionKey options\n- Conditionally adds RAG tools to the tools array when configured\n- Follows the same pattern as other conditional tools (web, image, etc.)\n\nFile committed with message: \"daedalus: 3.4 - Register RAG query tools in openclaw-tools.ts\" (commit b25374e2f)",
          "updated_at": "2026-02-03T18:55:55.176927+00:00"
        }
      ]
    },
    {
      "id": "phase-4",
      "name": "RAG Context Injection Hook",
      "description": "Create hook for automatic context injection at session start",
      "subtasks": [
        {
          "id": "4.1",
          "title": "Create rag-context-inject hook handler",
          "description": "Create src/hooks/bundled/rag-context-inject/handler.ts that queries all RAG sources and injects context into bootstrap files.",
          "status": "completed",
          "files_to_create": [
            "src/hooks/bundled/rag-context-inject/handler.ts"
          ],
          "files_to_reference": [
            "src/hooks/bundled/session-memory/handler.ts",
            "src/agents/bootstrap-hooks.ts"
          ],
          "acceptance_criteria": [
            "Triggers on agent:bootstrap event",
            "Queries Graphiti for recent entities/relationships",
            "Queries LightRAG for relevant document context",
            "Queries Memory Service for related memories",
            "Aggregates results into RAG_CONTEXT.md format",
            "Injects synthetic bootstrap file into bootstrapFiles array",
            "Respects maxEntities and maxRelations config",
            "Graceful degradation if services unavailable"
          ],
          "notes": "Successfully created src/hooks/bundled/rag-context-inject/handler.ts implementing the RAG context injection hook. The handler:\n- Listens for agent:bootstrap events\n- Queries all three RAG services (Graphiti, LightRAG, Memory Service) in parallel\n- Formats results into a markdown RAG_CONTEXT.md file\n- Injects synthetic bootstrap file into the bootstrapFiles array\n- Includes health checks for graceful degradation when services are unavailable\n- Respects configuration from hooks.internal.entries.rag-context-inject (maxEntities, maxRelations, maxMemories, maxDocuments)\n- Accesses RAG service configs from agents.defaults.memorySearch\n- TypeScript compilation passes without errors\n- File committed successfully with descriptive message (commit: 95056446d)",
          "updated_at": "2026-02-03T19:02:26.056499+00:00"
        },
        {
          "id": "4.2",
          "title": "Create rag-context-inject HOOK.md metadata",
          "description": "Create src/hooks/bundled/rag-context-inject/HOOK.md with hook metadata including name, description, events, and requirements.",
          "status": "completed",
          "files_to_create": [
            "src/hooks/bundled/rag-context-inject/HOOK.md"
          ],
          "files_to_reference": [
            "src/hooks/bundled/boot-md/HOOK.md",
            "src/hooks/bundled/session-memory/HOOK.md"
          ],
          "acceptance_criteria": [
            "YAML frontmatter with name, description, homepage",
            "openclaw metadata with emoji, events, requires, install",
            "Events: agent:bootstrap",
            "Requires: RAG service endpoints configured"
          ],
          "notes": "HOOK.md metadata file successfully created and corrected. Fixed event specification from [\"session:start\", \"message:first\"] to [\"agent:bootstrap\"] to match the actual handler implementation. Updated documentation to accurately describe the agent:bootstrap event timing. File includes YAML frontmatter with name, description, homepage, openclaw metadata with emoji (\ud83e\udde0), correct events, config requirements, and install info. Comprehensive documentation covers: What It Does, Output Format, Requirements, Configuration, RAG Services, When Context Is Injected, Disabling, and Troubleshooting. Committed with descriptive message (commit: 6e416d6e2).",
          "updated_at": "2026-02-03T19:12:48.528871+00:00"
        },
        {
          "id": "4.3",
          "title": "Create RAG context formatting utilities",
          "description": "Create src/hooks/bundled/rag-context-inject/format.ts with functions to format RAG results into markdown context.",
          "status": "completed",
          "files_to_create": [
            "src/hooks/bundled/rag-context-inject/format.ts"
          ],
          "files_to_reference": [
            "src/memory/status-format.ts"
          ],
          "acceptance_criteria": [
            "formatGraphitiContext for entities/relationships",
            "formatLightRAGContext for document answers",
            "formatMemoryServiceContext for memories",
            "combineRAGContext to merge all sources",
            "Proper markdown formatting with sections"
          ],
          "notes": "Created format.ts with dedicated formatting functions: formatGraphitiContext for entities/relationships, formatLightRAGContext for document answers, formatMemoryServiceContext for memories, and combineRAGContext to merge all sources into a single markdown context file. Refactored handler.ts to use the new format module, improving code organization and maintainability. All formatting logic is now properly separated into reusable utility functions.",
          "updated_at": "2026-02-03T19:18:32.970552+00:00"
        }
      ]
    },
    {
      "id": "phase-5",
      "name": "Integration & Wiring",
      "description": "Wire all components together and ensure proper registration",
      "subtasks": [
        {
          "id": "5.1",
          "title": "Export memory clients from index",
          "description": "Update src/memory/index.ts to export the new RAG clients.",
          "status": "completed",
          "files_to_modify": [
            "src/memory/index.ts"
          ],
          "acceptance_criteria": [
            "Export GraphitiClient",
            "Export LightRAGClient",
            "Export MemoryServiceClient",
            "Export client factory functions"
          ],
          "notes": "Successfully exported all three RAG clients from src/memory/index.ts. Exports include:\n- GraphitiClient, createGraphitiClient, and all Graphiti types\n- LightRAGClient, createLightRAGClient, and all LightRAG types\n- MemoryServiceClient, createMemoryServiceClient, and all MemoryService types\n\nAll acceptance criteria met. File already committed in bbfcc1b66.",
          "updated_at": "2026-02-03T19:58:53.882178+00:00"
        },
        {
          "id": "5.2",
          "title": "Create RAG config resolver",
          "description": "Create src/agents/rag-search.ts with functions to resolve RAG service configuration from OpenClawConfig.",
          "status": "completed",
          "files_to_create": [
            "src/agents/rag-search.ts"
          ],
          "files_to_reference": [
            "src/agents/memory-search.ts"
          ],
          "acceptance_criteria": [
            "resolveRAGSearchConfig function",
            "isGraphitiEnabled helper",
            "isLightRAGEnabled helper",
            "isMemoryServiceEnabled helper",
            "Get endpoint URLs from config"
          ],
          "notes": "Successfully created src/agents/rag-search.ts with all required functions following the pattern established by memory-search.ts. The module includes:\n- resolveRAGSearchConfig: Main function to resolve all RAG service configurations (Graphiti, LightRAG, Memory Service) for a specific agent, merging defaults and agent-specific overrides\n- isGraphitiEnabled, isLightRAGEnabled, isMemoryServiceEnabled: Helper functions to check if each service is enabled\n- getGraphitiEndpoint, getLightRAGEndpoint, getMemoryServiceEndpoint: Helper functions to get endpoint URLs for each service\n- ResolvedRAGSearchConfig types with proper defaults applied\n- All configurations respect the agent hierarchy (defaults + agent overrides) using resolveAgentConfig\n- Proper timeout clamping (minimum 1000ms)\n- File successfully committed (commit: 1665f35b1)",
          "updated_at": "2026-02-03T20:05:00.000000+00:00"
        },
        {
          "id": "5.3",
          "title": "Verify hook registration in loader",
          "description": "Verify that the rag-context-inject hook is discovered and registered by the hook loader system.",
          "status": "completed",
          "files_to_reference": [
            "src/hooks/loader.ts",
            "src/hooks/workspace.ts"
          ],
          "acceptance_criteria": [
            "Hook discovered in bundled hooks directory",
            "Hook registered for agent:bootstrap event",
            "Hook config read from openclaw.json"
          ],
          "notes": "Hook discovery and registration verified successfully:\n- Hook directory exists in src/hooks/bundled/rag-context-inject/ with proper structure\n- HOOK.md has valid frontmatter metadata specifying agent:bootstrap event\n- handler.ts has proper default export of injectRAGContext function\n- Hook follows same structure as other bundled hooks (boot-md, session-memory, etc.)\n- Bundled hooks directory is resolved by resolveBundledHooksDir()\n- Hook will be discovered by loadWorkspaceHookEntries() in workspace.ts\n- Hook will be registered by loadInternalHooks() in loader.ts at server startup\n- Comprehensive test suite created in discovery.test.ts covering all acceptance criteria\n- Verification documentation created in hook-verification.md\n- All acceptance criteria met: hook discovered, registered for agent:bootstrap, config support confirmed",
          "updated_at": "2026-02-03T20:21:25.259239+00:00"
        }
      ]
    },
    {
      "id": "phase-6",
      "name": "Testing & Documentation",
      "description": "Add tests and verify all functionality",
      "subtasks": [
        {
          "id": "6.1",
          "title": "Add unit tests for RAG clients",
          "description": "Create test files for LightRAG and Memory Service clients with mocked HTTP responses.",
          "status": "pending",
          "files_to_create": [
            "src/memory/graphiti-client.test.ts",
            "src/memory/lightrag-client.test.ts",
            "src/memory/memory-service-client.test.ts"
          ],
          "acceptance_criteria": [
            "Test successful query responses",
            "Test error handling",
            "Test timeout behavior",
            "Test health check failures"
          ]
        },
        {
          "id": "6.2",
          "title": "Add unit tests for RAG tools",
          "description": "Create test files for the three RAG query tools.",
          "status": "pending",
          "files_to_create": [
            "src/agents/tools/graphiti-search-tool.test.ts",
            "src/agents/tools/lightrag-query-tool.test.ts",
            "src/agents/tools/memory-service-query-tool.test.ts"
          ],
          "acceptance_criteria": [
            "Test tool creation with valid config",
            "Test tool returns null when disabled",
            "Test tool execution with mocked client",
            "Test graceful degradation"
          ]
        },
        {
          "id": "6.3",
          "title": "Add unit tests for rag-context-inject hook",
          "description": "Create test file for the RAG context injection hook.",
          "status": "pending",
          "files_to_create": [
            "src/hooks/bundled/rag-context-inject/handler.test.ts"
          ],
          "acceptance_criteria": [
            "Test hook triggers on agent:bootstrap",
            "Test context injection into bootstrapFiles",
            "Test graceful degradation when services down",
            "Test config-based enabling/disabling"
          ]
        },
        {
          "id": "6.4",
          "title": "Manual integration testing",
          "description": "Perform manual testing with RAG services running to verify end-to-end functionality.",
          "status": "pending",
          "acceptance_criteria": [
            "Start RAG services via docker-compose",
            "Configure OpenClaw with all endpoints",
            "Start agent session and verify RAG_CONTEXT.md appears",
            "Call each tool manually and verify results",
            "Stop one service and verify graceful degradation"
          ]
        }
      ]
    }
  ],
  "qa_signoff": {
    "status": "pending",
    "tests_passed": "",
    "issues": ""
  },
  "notes": [
    "This implementation follows existing patterns from memory-tool.ts and session-memory hook",
    "All RAG services communicate via HTTP APIs on localhost",
    "Graceful degradation is critical - agent must continue if any RAG service is unavailable",
    "The rag-context-inject hook uses the agent:bootstrap event to inject synthetic bootstrap files",
    "Tools are conditionally created based on memorySearch config in openclaw.json"
  ],
  "last_updated": "2026-02-03T20:21:25.259247+00:00"
}