#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
RUN_NODE_TOOL="$ROOT_DIR/scripts/pre-commit/run-node-tool.sh"

if [[ ! -x "$RUN_NODE_TOOL" ]]; then
  echo "Missing helper: $RUN_NODE_TOOL" >&2
  exit 1
fi

declare -a FILES=()
while IFS= read -r -d '' file; do
  FILES+=("$file")
done < <(git diff --cached --name-only --diff-filter=ACMR -z)

if [[ ${#FILES[@]} -eq 0 ]]; then
  exit 0
fi

"$RUN_NODE_TOOL" oxlint --type-aware --fix "${FILES[@]}"
"$RUN_NODE_TOOL" oxfmt --write --no-error-on-unmatched-pattern "${FILES[@]}"
git add -- "${FILES[@]}"
