---
summary: "mac App 中的語音喚醒與按鍵通話模式，以及路由細節"
read_when:
  - 進行語音喚醒或 PTT 流程相關開發時
title: "語音喚醒"
x-i18n:
  source_path: platforms/mac/voicewake.md
  source_hash: f6440bb89f349ba5
  provider: openai
  model: gpt-5.2-chat-latest
  workflow: v1
  generated_at: 2026-02-08T06:54:14Z
---

# 語音喚醒 & 按鍵通話

## 模式

- **喚醒詞模式**（預設）：常駐的語音辨識器會等待觸發詞（`swabbleTriggerWords`）。命中後即開始收音，顯示包含即時文字的覆蓋層，並在偵測到靜音後自動送出。
- **按鍵通話（按住右 Option）**：按住右側 Option 鍵即可立即收音——無需觸發詞。按住期間顯示覆蓋層；放開後在短暫延遲後完成並轉送，讓你有時間微調文字。

## 執行期行為（喚醒詞）

- 語音辨識器運行於 `VoiceWakeRuntime`。
- 僅在喚醒詞與下一個詞之間出現 **有意義的停頓** 時才會觸發（約 0.55 秒間隔）。覆蓋層／提示音可在停頓時就開始，甚至早於指令本身。
- 靜音視窗：語音持續時為 2.0 秒；若只聽到觸發詞則為 5.0 秒。
- 強制停止：120 秒，避免工作階段失控。
- 工作階段間的防彈跳：350 毫秒。
- 覆蓋層透過 `VoiceWakeOverlayController` 驅動，並以已提交／暫態配色呈現。
- 送出後，辨識器會乾淨地重新啟動以聆聽下一次觸發。

## 生命週期不變量

- 若已啟用語音喚醒且權限齊備，喚醒詞辨識器應持續聆聽（除非正在進行明確的按鍵通話收音）。
- 覆蓋層的可見性（包含以 X 按鈕手動關閉）絕不可阻止辨識器恢復運作。

## 覆蓋層卡住的失敗模式（先前）

過去若覆蓋層卡在可見狀態且你手動關閉它，語音喚醒可能看起來「失效」，因為執行期嘗試重新啟動時可能被覆蓋層可見性阻擋，且未排程後續重啟。

強化措施：

- 喚醒執行期的重新啟動不再受覆蓋層可見性阻擋。
- 覆蓋層關閉完成會透過 `VoiceSessionCoordinator` 觸發 `VoiceWakeRuntime.refresh(...)`，因此手動以 X 關閉一定會恢復聆聽。

## 按鍵通話細節

- 快捷鍵偵測使用全域 `.flagsChanged` 監聽 **右 Option**（`keyCode 61` + `.option`）。僅觀察事件（不攔截）。
- 收音管線位於 `VoicePushToTalk`：立即啟動語音、將即時片段串流至覆蓋層，並在放開時呼叫 `VoiceWakeForwarder`。
- 按鍵通話開始時會暫停喚醒詞執行期以避免音訊監聽衝突；放開後會自動重新啟動。
- 權限：需要麥克風 + 語音；要看到事件需核准輔助使用／輸入監控。
- 外接鍵盤：部分裝置可能未如預期暴露右 Option——若使用者回報漏判，請提供備用快捷鍵。

## 使用者設定

- **語音喚醒** 切換：啟用喚醒詞執行期。
- **按住 Cmd+Fn 說話**：啟用按鍵通話監聽。於 macOS < 26 停用。
- 語言與麥克風選擇器、即時音量表、觸發詞表、測試器（僅本機；不轉送）。
- 麥克風選擇器會在裝置中斷時保留上次選擇，顯示中斷提示，並在裝置回來前暫時回退至系統預設。
- **音效**：觸發偵測與送出時的提示音；預設為 macOS 的「Glass」系統音效。每個事件可選擇任何 `NSSound` 可載入的檔案（例如 MP3/WAV/AIFF），或選擇 **無音效**。

## 轉送行為

- 啟用語音喚醒時，逐字稿會轉送至作用中的 Gateway 閘道器／代理程式（與 mac App 其餘功能相同的本機或遠端模式）。
- 回覆會送達 **最近使用的主要提供者**（WhatsApp/Telegram/Discord/WebChat）。若傳送失敗，會記錄錯誤，且仍可透過 WebChat／工作階段記錄查看此次執行。

## 轉送酬載

- `VoiceWakeForwarder.prefixedTranscript(_:)` 會在送出前加入機器提示；喚醒詞與按鍵通話流程共用。

## 快速驗證

- 開啟按鍵通話，按住 Cmd+Fn，說話，放開：覆蓋層應顯示即時片段後送出。
- 按住期間，選單列的耳朵圖示應維持放大（使用 `triggerVoiceEars(ttl:nil)`）；放開後即回復。
