# Web Search TTS Integration - UI Flow

> Status: READY | Last updated: 2025-01-05

## User Journey

```
┌────────────────────────────────────────────┐
│            USER INPUT                      │
│  "/web погода в Москве сегодня"           │
└───────────────┬────────────────────────────┘
                │
                ▼
┌────────────────────────────────────────────┐
│          WEB SEARCH EXECUTION              │
│  → executeWebSearch() called              │
│  → Gemini API queried                     │
│  → Results returned                       │
└───────────────┬────────────────────────────┘
                │
                ▼
┌────────────────────────────────────────────┐
│      RESULT DELIVERY MESSAGE               │
│  ┌──────────────────────────────────────┐  │
│  │ ○ Результат поиска:                  │  │
│  │                                     │  │
│  │ Сегодня в Москве ожидается...        │  │
│  │                                     │  │
│  │  ┌──────────────────────────────┐   │  │
│  │  │  🔊 Озвучить                  │   │  │  ← NEW
│  │  └──────────────────────────────┘   │  │
│  └──────────────────────────────────────┘  │
└───────────────┬────────────────────────────┘
                │
                ▼ (user clicks button)
┌────────────────────────────────────────────┐
│      BUTTON UPDATE - PROGRESS 0%           │
│  ┌──────────────────────────────────────┐  │
│  │  ⏳ 0% ░░░░░░░░░░░░                   │  │
│  └──────────────────────────────────────┘  │
└───────────────┬────────────────────────────┘
                │
                ▼ (check cache)
┌────────────────────────────────────────────┐
│    CACHE CHECK (SHA-256 of result text)    │
│  → Hit? → Skip to 100%, send audio        │
│  → Miss? → Call MiniMax API               │
└───────────────┬────────────────────────────┘
                │ (cache miss)
                ▼
┌────────────────────────────────────────────┐
│      BUTTON UPDATE - PROGRESS 25%          │
│  ┌──────────────────────────────────────┐  │
│  │  ⏳ 25% ▮▮░░░░░░░░                    │  │
│  └──────────────────────────────────────┘  │
└───────────────┬────────────────────────────┘
                │
                ▼ (call MiniMax API)
┌────────────────────────────────────────────┐
│      BUTTON UPDATE - PROGRESS 50%          │
│  ┌──────────────────────────────────────┐  │
│  │  ⏳ 50% ▮▮▮▮░░░░░░                    │  │
│  └──────────────────────────────────────┘  │
└───────────────┬────────────────────────────┘
                │
                ▼ (receiving response)
┌────────────────────────────────────────────┐
│      BUTTON UPDATE - PROGRESS 75%          │
│  ┌──────────────────────────────────────┐  │
│  │  ⏳ 75% ▮▮▮▮▮▮░░░░                    │  │
│  └──────────────────────────────────────┘  │
└───────────────┬────────────────────────────┘
                │
                ▼ (decoding audio)
┌────────────────────────────────────────────┐
│      BUTTON UPDATE - PROGRESS 100%         │
│  ┌──────────────────────────────────────┐  │
│  │  ⏳ 100% ▮▮▮▮▮▮▮▮▮▮                   │  │
│  └──────────────────────────────────────┘  │
└───────────────┬────────────────────────────┘
                │
                ▼ (save to cache)
┌────────────────────────────────────────────┐
│         BUTTON REMOVED                     │
│  → Reply markup cleared                    │
│  → Audio file sent to chat                │
│  ┌──────────────────────────────────────┐  │
│  │  🎙️ <Audio player>                  │  │
│  │  今天在莫斯科...                      │  │
│  └──────────────────────────────────────┘  │
└────────────────────────────────────────────┘
```

## Error Flow

```
┌────────────────────────────────────────────┐
│      USER CLICKS "Озвучить"                │
└───────────────┬────────────────────────────┘
                │
                ▼
┌────────────────────────────────────────────┐
│      MINIMAX API CALL FAILS                │
│  → Error: timeout, 429, 500, etc.         │
└───────────────┬────────────────────────────┘
                │
                ▼
┌────────────────────────────────────────────┐
│         BUTTON REMOVED                     │
│  → Edit message, remove reply markup       │
└───────────────┬────────────────────────────┘
                │
                ▼
┌────────────────────────────────────────────┐
│         ERROR MESSAGE SHOWN                │
│  ┌──────────────────────────────────────┐  │
│  │  ✂︎ Озвучка не удалась:              │  │
│  │  Истекло время ожидания запроса      │  │
│  └──────────────────────────────────────┘  │
└────────────────────────────────────────────┘
```

## Message Templates

### Initial Result Message (Existing + Button)

```
○ Результат поиска:

Сегодня в Москве ожидается переменная облачность,
температура воздуха от -2°C до +3°C...

[🔊 Озвучить] ← inline button
```

### Progress States

| Stage | Button Text |
|-------|-------------|
| 0% | `⏳ 0% ░░░░░░░░░░░░` |
| 25% | `⏳ 25% ▮▮░░░░░░░░` |
| 50% | `⏳ 50% ▮▮▮▮░░░░░░` |
| 75% | `⏳ 75% ▮▮▮▮▮▮░░░░` |
| 100% | `⏳ 100% ▮▮▮▮▮▮▮▮▮▮▮` |

### Error Message

```
✂︎ Озвучка не удалась:

Истекло время ожидания запроса (timeout)
```

### Success (Audio File)

```
🎙️ <Audio player with waveform>

Caption: (same as web search result text)
```

## Technical Implementation Notes

### Callback Data Format

- Prefix: `tts:`
- Format: `tts:{hash}` where hash is first 12 chars of SHA-256
- Example: `tts:a3f5e2b1c4d9`

### Progress Bar Characters

- Filled: `▮` (U+25AE)
- Empty: `░` (U+2591)
- 10 segments total (10% per segment)

### Message Editing Pattern

```typescript
// Update button text only
await ctx.api.editMessageReplyMarkup(
  chatId,
  messageId,
  new InlineKeyboard().text("⏳ 50% ▮▮▮░░░░░░", "tts:a3f5e2b1c4d9")
);

// Remove button (after audio sent)
await ctx.api.editMessageReplyMarkup(chatId, messageId);
```

### Cache File Structure

```
~/.clawdis/
└── cache/
    └── tts/
        ├── a3f5e2b1c4d9.mp3
        ├── b4f6e1c2d5e8.mp3
        └── ...
```
