---
summary: "OpenClaw のプレゼンスエントリがどのように生成・マージされ、表示されるか"
read_when:
  - Instances タブのデバッグ
  - 重複または古いインスタンス行の調査
  - Gateway（ゲートウェイ）WS 接続または system-event ビーコンの変更
title: "プレゼンス"
x-i18n:
  source_path: concepts/presence.md
  source_hash: c752c76a880878fe
  provider: openai
  model: gpt-5.2-pro
  workflow: v1
  generated_at: 2026-02-06T05:07:31Z
---

# プレゼンス

OpenClaw の「プレゼンス」は、次の対象についての軽量なベストエフォートのビューです。

- **Gateway（ゲートウェイ）** 自体、および
- **Gateway（ゲートウェイ）に接続しているクライアント**（mac アプリ、WebChat、CLI など）

プレゼンスは主に、macOS アプリの **Instances** タブを描画し、オペレーターがすばやく状況を把握できるようにするために使用されます。

## プレゼンスフィールド（表示される内容）

プレゼンスエントリは、次のようなフィールドを持つ構造化オブジェクトです。

- `instanceId`（任意ですが強く推奨）: 安定したクライアント識別子（通常は `connect.client.instanceId`）
- `host`: 人が判読しやすいホスト名
- `ip`: ベストエフォートの IP アドレス
- `version`: クライアントのバージョン文字列
- `deviceFamily` / `modelIdentifier`: ハードウェアに関するヒント
- `mode`: `ui`、`webchat`、`cli`、`backend`、`probe`、`test`、`node`、...
- `lastInputSeconds`: 「最後のユーザー入力からの経過秒数」（既知の場合）
- `reason`: `self`、`connect`、`node-connected`、`periodic`、...
- `ts`: 最終更新タイムスタンプ（エポックからの ms）

## プロデューサー（プレゼンスの供給元）

プレゼンスエントリは複数のソースにより生成され、**マージ**されます。

### 1) Gateway（ゲートウェイ）の自己エントリ

Gateway（ゲートウェイ）は起動時に常に「self」エントリをシードします。これにより、クライアントが接続する前でも UI にゲートウェイホストが表示されます。

### 2) WebSocket 接続

すべての WS クライアントは `connect` リクエストから始まります。ハンドシェイクが成功すると、Gateway（ゲートウェイ）はその接続に対するプレゼンスエントリを upsert します。

#### ワンオフの CLI コマンドが表示されない理由

CLI は短時間のワンオフコマンドのために接続することがよくあります。Instances リストのスパムを避けるため、`client.mode === "cli"` はプレゼンスエントリに **変換されません**。

### 3) `system-event` ビーコン

クライアントは `system-event` メソッドを通じて、よりリッチな周期的ビーコンを送信できます。mac アプリはこれを使用して、ホスト名、IP、および `lastInputSeconds` を報告します。

### 4) ノード接続（role: node）

ノードが `role: node` で Gateway（ゲートウェイ）の WebSocket に接続すると、Gateway（ゲートウェイ）はそのノードに対するプレゼンスエントリを upsert します（他の WS クライアントと同じフローです）。

## マージ + 重複排除ルール（`instanceId` が重要な理由）

プレゼンスエントリは、単一のインメモリマップに保存されます。

- エントリは **プレゼンスキー** でキー付けされます。
- 最良のキーは、再起動をまたいでも存続する安定した `instanceId`（`connect.client.instanceId` 由来）です。
- キーは大文字小文字を区別しません。

クライアントが安定した `instanceId` なしで再接続すると、**重複**行として表示される場合があります。

## TTL とサイズ上限

プレゼンスは意図的にエフェメラルです。

- **TTL:** 5 分より古いエントリは間引かれます
- **最大エントリ数:** 200（最も古いものから削除）

これにより、リストを新鮮に保ち、メモリが無制限に増加することを防ぎます。

## リモート/トンネルの注意点（loopback IP）

クライアントが SSH トンネル / ローカルポートフォワード経由で接続すると、Gateway（ゲートウェイ）はリモートアドレスを `127.0.0.1` として認識する場合があります。良好なクライアント報告 IP を上書きしないように、loopback のリモートアドレスは無視されます。

## コンシューマー

### macOS の Instances タブ

macOS アプリは `system-presence` の出力を描画し、最終更新の経過時間に基づいて小さなステータスインジケーター（Active/Idle/Stale）を適用します。

## デバッグのヒント

- 生のリストを確認するには、Gateway（ゲートウェイ）に対して `system-presence` を呼び出します。
- 重複が見える場合:
  - クライアントがハンドシェイクで安定した `client.instanceId` を送っていることを確認します
  - 周期的ビーコンが同じ `instanceId` を使用していることを確認します
  - 接続由来のエントリに `instanceId` が欠けていないか確認します（重複は想定どおりです）
