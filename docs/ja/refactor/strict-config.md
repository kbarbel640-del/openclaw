---
summary: 「厳格な設定検証 + Doctor 専用のマイグレーション」
read_when:
  - 設定検証の挙動を設計または実装している場合
  - 設定マイグレーションや Doctor ワークフローに取り組んでいる場合
  - プラグイン設定スキーマやプラグイン読み込みのゲーティングを扱う場合
title: 「厳格な設定検証」
x-i18n:
  source_path: refactor/strict-config.md
  source_hash: 5bc7174a67d2234e
  provider: openai
  model: gpt-5.2-chat-latest
  workflow: v1
  generated_at: 2026-02-08T06:34:50Z
---

# 厳格な設定検証（Doctor 専用のマイグレーション）

## 目標

- **未知の設定キーをすべて拒否**（ルート + ネスト）。
- **スキーマのないプラグイン設定を拒否**；そのプラグインは読み込まない。
- **読み込み時のレガシー自動マイグレーションを廃止**；マイグレーションは Doctor 経由のみで実行。
- **起動時に Doctor（ドライラン）を自動実行**；無効な場合は診断以外のコマンドをブロック。

## 非目標

- 読み込み時の後方互換性（レガシーキーは自動マイグレーションしない）。
- 未認識キーのサイレントドロップ。

## 厳格な検証ルール

- 設定はすべての階層でスキーマに完全一致する必要があります。
- 未知のキーは検証エラーです（ルートやネストでのパススルーはありません）。
- `plugins.entries.<id>.config` はプラグインのスキーマで検証されなければなりません。
  - プラグインにスキーマがない場合、**プラグインの読み込みを拒否**し、明確なエラーを表示します。
- 未知の `channels.<id>` キーは、プラグインマニフェストがチャンネル ID を宣言していない限りエラーです。
- プラグインマニフェスト（`openclaw.plugin.json`）はすべてのプラグインで必須です。

## プラグインスキーマの強制

- 各プラグインは、その設定に対する厳格な JSON Schema を提供します（マニフェスト内にインライン）。
- プラグイン読み込みフロー：
  1. プラグインマニフェスト + スキーマを解決（`openclaw.plugin.json`）。
  2. スキーマに対して設定を検証。
  3. スキーマ欠如または設定不正の場合：プラグインの読み込みをブロックし、エラーを記録。
- エラーメッセージに含める内容：
  - プラグイン ID
  - 理由（スキーマ欠如 / 設定不正）
  - 検証に失敗したパス
- 無効化されたプラグインは設定を保持しますが、Doctor とログで警告を表示します。

## Doctor フロー

- Doctor は設定が読み込まれる **毎回** 実行されます（既定はドライラン）。
- 設定が無効な場合：
  - 要約と実行可能なエラーを出力。
  - 指示：`openclaw doctor --fix`。
- `openclaw doctor --fix`：
  - マイグレーションを適用。
  - 未知のキーを削除。
  - 更新された設定を書き込み。

## コマンドのゲーティング（設定が無効な場合）

許可（診断専用）：

- `openclaw doctor`
- `openclaw logs`
- `openclaw health`
- `openclaw help`
- `openclaw status`
- `openclaw gateway status`

それ以外はすべて、次のメッセージでハード失敗しなければなりません：「設定が無効です。`openclaw doctor --fix` を実行してください。」

## エラー UX 形式

- 単一の要約ヘッダー。
- グループ化されたセクション：
  - 未知のキー（完全パス）
  - レガシーキー / 必要なマイグレーション
  - プラグイン読み込み失敗（プラグイン ID + 理由 + パス）

## 実装のタッチポイント

- `src/config/zod-schema.ts`：ルートのパススルーを削除；全階層で厳格なオブジェクト。
- `src/config/zod-schema.providers.ts`：厳格なチャンネルスキーマを保証。
- `src/config/validation.ts`：未知のキーで失敗；レガシーマイグレーションを適用しない。
- `src/config/io.ts`：レガシー自動マイグレーションを削除；常に Doctor のドライランを実行。
- `src/config/legacy*.ts`：使用箇所を Doctor のみに移行。
- `src/plugins/*`：スキーマレジストリ + ゲーティングを追加。
- `src/cli` で CLI コマンドのゲーティング。

## テスト

- 未知のキーの拒否（ルート + ネスト）。
- プラグインにスキーマがない → 明確なエラーでプラグイン読み込みをブロック。
- 無効な設定 → 診断コマンド以外ではゲートウェイ起動をブロック。
- Doctor は自動でドライラン；`doctor --fix` が修正済み設定を書き込み。
