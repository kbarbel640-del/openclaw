---
summary: "リファレンス：プロバイダー別のトランスクリプトのサニタイズおよび修復ルール"
read_when:
  - トランスクリプトの形状に起因するプロバイダーのリクエスト拒否をデバッグしているとき
  - トランスクリプトのサニタイズやツールコール修復ロジックを変更しているとき
  - プロバイダー間でのツールコール ID の不一致を調査しているとき
title: "トランスクリプト・ハイジーン"
x-i18n:
  source_path: reference/transcript-hygiene.md
  source_hash: 43ed460827d514a8
  provider: openai
  model: gpt-5.2-chat-latest
  workflow: v1
  generated_at: 2026-02-08T06:35:01Z
---

# トランスクリプト・ハイジーン（プロバイダー修正）

本ドキュメントでは、実行前（モデルコンテキストの構築時）にトランスクリプトへ適用される**プロバイダー固有の修正**について説明します。これらは、厳格なプロバイダー要件を満たすために用いられる**インメモリ**の調整です。これらのハイジーン手順は、ディスク上に保存されている JSONL トランスクリプトを書き換えることは**ありません**。ただし、別途セッションファイルの修復パスにより、セッション読み込み前に不正な JSONL ファイルから無効な行を削除して書き換える場合があります。修復が発生した場合、元のファイルはセッションファイルと並んでバックアップされます。

対象範囲は次を含みます：

- ツールコール ID のサニタイズ
- ツールコール入力の検証
- ツール結果のペアリング修復
- ターンの検証／順序付け
- 思考シグネチャのクリーンアップ
- 画像ペイロードのサニタイズ

トランスクリプトの保存に関する詳細が必要な場合は、次を参照してください：

- [/reference/session-management-compaction](/reference/session-management-compaction)

---

## 実行箇所

すべてのトランスクリプト・ハイジーンは、組み込みランナーに集約されています：

- ポリシー選択：`src/agents/transcript-policy.ts`
- サニタイズ／修復の適用：`sanitizeSessionHistory`（`src/agents/pi-embedded-runner/google.ts` 内）

このポリシーは、`provider`、`modelApi`、`modelId` を用いて適用内容を決定します。

トランスクリプト・ハイジーンとは別に、セッションファイルはロード前に（必要に応じて）修復されます：

- `repairSessionFileIfNeeded`（`src/agents/session-file-repair.ts` 内）
- `run/attempt.ts` および `compact.ts`（組み込みランナー）から呼び出されます

---

## グローバルルール：画像のサニタイズ

画像ペイロードは、サイズ制限によるプロバイダー側の拒否を防ぐため、常にサニタイズされます（過大な base64 画像のダウンスケール／再圧縮）。

実装：

- `sanitizeSessionMessagesImages`（`src/agents/pi-embedded-helpers/images.ts` 内）
- `sanitizeContentBlocksImages`（`src/agents/tool-images.ts` 内）

---

## グローバルルール：不正なツールコール

`input` と `arguments` の両方を欠くアシスタントのツールコール・ブロックは、モデルコンテキストの構築前に削除されます。これは、部分的に永続化されたツールコール（たとえばレート制限失敗後）によるプロバイダー拒否を防ぐためです。

実装：

- `sanitizeToolCallInputs`（`src/agents/session-transcript-repair.ts` 内）
- `sanitizeSessionHistory`（`src/agents/pi-embedded-runner/google.ts` 内）で適用

---

## プロバイダー別マトリクス（現行の挙動）

**OpenAI / OpenAI Codex**

- 画像のサニタイズのみ。
- OpenAI Responses／Codex へのモデル切り替え時、孤立した推論シグネチャ（後続のコンテンツブロックを持たない単独の推論項目）を削除。
- ツールコール ID のサニタイズなし。
- ツール結果のペアリング修復なし。
- ターンの検証や並べ替えなし。
- 合成ツール結果なし。
- 思考シグネチャの削除なし。

**Google（Generative AI / Gemini CLI / Antigravity）**

- ツールコール ID のサニタイズ：厳格な英数字。
- ツール結果のペアリング修復および合成ツール結果。
- ターン検証（Gemini 方式のターン交互）。
- Google のターン順序修正（履歴がアシスタントから始まる場合、極小のユーザー・ブートストラップを先頭に追加）。
- Antigravity Claude：思考シグネチャを正規化し、署名のない思考ブロックを削除。

**Anthropic / Minimax（Anthropic 互換）**

- ツール結果のペアリング修復および合成ツール結果。
- ターン検証（厳格な交互要件を満たすため、連続するユーザーターンをマージ）。

**Mistral（モデル ID ベースの検出を含む）**

- ツールコール ID のサニタイズ：strict9（英数字 9 文字）。

**OpenRouter Gemini**

- 思考シグネチャのクリーンアップ：base64 ではない `thought_signature` 値を削除（base64 は保持）。

**その他すべて**

- 画像のサニタイズのみ。

---

## 過去の挙動（2026.1.22 以前）

2026.1.22 リリース以前は、OpenClaw は複数層のトランスクリプト・ハイジーンを適用していました：

- **トランスクリプト・サニタイズ拡張**が、すべてのコンテキスト構築時に実行され、次が可能でした：
  - ツール使用／結果のペアリング修復。
  - ツールコール ID のサニタイズ（`_`/`-` を保持する非厳格モードを含む）。
- ランナーでもプロバイダー固有のサニタイズを実行しており、作業が重複していました。
- プロバイダーポリシー外でも追加の変更が行われており、次を含みます：
  - 永続化前にアシスタント本文から `<final>` タグを削除。
  - 空のアシスタント・エラーターンを削除。
  - ツールコール後のアシスタント内容をトリミング。

この複雑さは、プロバイダー間のリグレッション（特に `openai-responses` と `call_id|fc_id` のペアリング）を引き起こしました。2026.1.22 のクリーンアップにより拡張は削除され、ロジックはランナーに集約され、OpenAI は画像サニタイズ以外は**ノータッチ**となりました。
