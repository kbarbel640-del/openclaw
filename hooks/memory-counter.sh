#!/bin/bash
# Memory Counter Hook ‚Äî –∫–∞–∂–¥—ã–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–Ω–∂–µ–∫—Ç–∏—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∞—Ç—å –≤–∞–∂–Ω–æ–µ –≤ –ø–∞–º—è—Ç—å
# –°—á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ heartbeat, –Ω–µ cron)

COUNTER_FILE="/tmp/openclaw-msg-counter"
INPUT=$(cat)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∞ –Ω–µ heartbeat/system
USER_MSG=$(echo "$INPUT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('prompt',''))" 2>/dev/null)

# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º heartbeat –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ
if echo "$USER_MSG" | grep -qiE '(HEARTBEAT|heartbeat_ok|Context check|üìä)'; then
  exit 0
fi

# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ
if [ -z "$USER_MSG" ]; then
  exit 0
fi

# –ß–∏—Ç–∞–µ–º/–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏–º —Å—á—ë—Ç—á–∏–∫
COUNT=0
if [ -f "$COUNTER_FILE" ]; then
  COUNT=$(cat "$COUNTER_FILE" 2>/dev/null || echo 0)
fi
COUNT=$((COUNT + 1))
echo "$COUNT" > "$COUNTER_FILE"

# –ö–∞–∂–¥—ã–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî —Ç—Ä–∏–≥–≥–µ—Ä
if [ $((COUNT % 5)) -eq 0 ]; then
  cat << 'MEMFLUSH'

## Memory Flush (auto-injected, –∫–∞–∂–¥—ã–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π)

–ü—Ä–æ—Å–º–æ—Ç—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –æ–±–º–µ–Ω–æ–≤. –ï—Å–ª–∏ –±—ã–ª–æ —á—Ç–æ-—Ç–æ –∏–∑ —Å–ø–∏—Å–∫–∞ ‚Äî –∑–∞–ø–∏—à–∏ 1-3 —Å—Ç—Ä–æ–∫–∏ –≤ memory/YYYY-MM-DD.md:
- –†–µ—à–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –í–ª–∞–¥–∞
- –ù–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–∫–ª—é—á–∏, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –ø–ª–∞–Ω—ã)
- –û—à–∏–±–∫–∞ –∏–ª–∏ —É—Ä–æ–∫
- –ó–∞–¥–∞—á–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç–∞

–ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –≤–∞–∂–Ω–æ–≥–æ ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏ –º–æ–ª—á–∞. –ù–ï –ø–∏—à–∏ "–Ω–∏—á–µ–≥–æ –≤–∞–∂–Ω–æ–≥–æ –Ω–µ –±—ã–ª–æ".
MEMFLUSH
fi
