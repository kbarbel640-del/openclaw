<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinClaw Commons Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="chart.min.js" defer></script>
</head>
<body>
<div class="dashboard">

  <!-- 1. Header -->
  <header class="header">
    <h1>OpenFinClaw Commons</h1>
    <span class="badge" id="total-badge">‚Äî entries</span>
  </header>

  <!-- 2. Radar Chart -->
  <section class="section">
    <h2>7-Dimension Overview</h2>
    <div class="chart-row">
      <div class="chart-container">
        <canvas id="radar-chart" height="300"></canvas>
      </div>
      <!-- 3. Dimension Cards -->
      <div class="card-grid" id="dimension-cards"></div>
    </div>
  </section>

  <!-- 4. Leaderboard -->
  <section class="section">
    <h2>Top Contributors</h2>
    <div class="table-container">
      <table id="leaderboard-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Contributor</th>
            <th>Entries</th>
            <th>FCS Avg</th>
            <th>Top Dimension</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- 5. Entry Browser -->
  <section class="section">
    <h2>Entry Browser</h2>
    <div class="filter-bar">
      <select id="filter-type">
        <option value="">All Types</option>
        <option value="skill">Skills</option>
        <option value="strategy">Strategies</option>
        <option value="connector">Connectors</option>
        <option value="persona">Personas</option>
        <option value="workspace">Workspaces</option>
        <option value="knowledge-pack">Knowledge Packs</option>
        <option value="compliance-ruleset">Compliance Rulesets</option>
      </select>
      <select id="filter-lifecycle">
        <option value="">All Tiers</option>
        <option value="seedling">üå± Seedling</option>
        <option value="growing">üåø Growing</option>
        <option value="established">üå≥ Established</option>
      </select>
      <input type="text" id="filter-search" placeholder="Search entries...">
    </div>
    <div class="table-container">
      <table id="entries-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>ID</th>
            <th>Name</th>
            <th>FCS</th>
            <th>Tier</th>
            <th>Author</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- 6. Growth Timeline -->
  <section class="section">
    <h2>Growth Timeline</h2>
    <div class="chart-container">
      <canvas id="timeline-chart" height="250"></canvas>
    </div>
  </section>

  <!-- 7. Strategy Performance (conditional) -->
  <section class="section" id="strategy-section" style="display:none">
    <h2>Strategy Performance</h2>
    <div class="table-container">
      <table class="strategy-table" id="strategy-table">
        <thead>
          <tr>
            <th>Strategy</th>
            <th>FCS</th>
            <th>Sharpe</th>
            <th>Max DD</th>
            <th>Return</th>
            <th>Win Rate</th>
            <th>Trades</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <footer class="footer">
    Generated by <strong>FinClaw Commons</strong> &mdash; <span id="generated-at"></span>
  </footer>
</div>

<script>
/* global Chart */
(function() {
  const DATA = window.__FINCLAW_DATA__;
  if (!DATA) return;

  const { overview, entries } = DATA;
  const TYPE_EMOJI = {
    skill: 'üõ†', strategy: 'üìä', connector: 'üîå', persona: 'üé≠',
    workspace: 'üìÅ', 'knowledge-pack': 'üìö', 'compliance-ruleset': 'üìã'
  };
  const TYPE_LABELS = {
    skill: 'Skills', strategy: 'Strategies', connector: 'Connectors',
    persona: 'Personas', workspace: 'Workspaces',
    'knowledge-pack': 'Knowledge Packs', 'compliance-ruleset': 'Compliance Rulesets'
  };
  const TIER_LABEL = { seedling: 'üå± Seedling', growing: 'üåø Growing', established: 'üå≥ Established' };
  const ACCENT = '#FF5A2D';
  const ACCENT_50 = 'rgba(255, 90, 45, 0.3)';

  // Header badge
  document.getElementById('total-badge').textContent = overview.totalEntries + ' entries';
  document.getElementById('generated-at').textContent = new Date().toLocaleDateString();

  // Dimension cards
  const cardsContainer = document.getElementById('dimension-cards');
  overview.dimensions.forEach(function(dim) {
    const total = dim.seedling + dim.growing + dim.established;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML =
      '<div class="emoji">' + (TYPE_EMOJI[dim.type] || 'üì¶') + '</div>' +
      '<div class="count">' + dim.count + '</div>' +
      '<div class="label">' + (TYPE_LABELS[dim.type] || dim.type) + '</div>' +
      (total > 0 ? '<div class="lifecycle-bar">' +
        (dim.seedling > 0 ? '<div class="seedling" style="flex:' + dim.seedling + '"></div>' : '') +
        (dim.growing > 0 ? '<div class="growing" style="flex:' + dim.growing + '"></div>' : '') +
        (dim.established > 0 ? '<div class="established" style="flex:' + dim.established + '"></div>' : '') +
      '</div>' : '');
    cardsContainer.appendChild(card);
  });

  // Radar chart
  if (typeof Chart !== 'undefined') {
    var radarCtx = document.getElementById('radar-chart').getContext('2d');
    new Chart(radarCtx, {
      type: 'radar',
      data: {
        labels: overview.dimensions.map(function(d) { return TYPE_LABELS[d.type] || d.type; }),
        datasets: [{
          label: 'Entries',
          data: overview.dimensions.map(function(d) { return d.count; }),
          borderColor: ACCENT,
          backgroundColor: ACCENT_50,
          pointBackgroundColor: ACCENT,
          pointRadius: 4
        }]
      },
      options: {
        scales: { r: { beginAtZero: true, ticks: { stepSize: 1, color: '#8b949e' }, grid: { color: '#30363d' }, pointLabels: { color: '#e6edf3' } } },
        plugins: { legend: { display: false } }
      }
    });
  }

  // Leaderboard
  var lbBody = document.querySelector('#leaderboard-table tbody');
  overview.topContributors.forEach(function(c, i) {
    var tr = document.createElement('tr');
    tr.innerHTML =
      '<td>#' + (i + 1) + '</td>' +
      '<td>' + c.author + '</td>' +
      '<td>' + c.count + '</td>' +
      '<td>' + (c.averageFcs > 0 ? c.averageFcs.toFixed(1) : '‚Äî') + '</td>' +
      '<td>' + (TYPE_LABELS[c.types[0]] || c.types[0] || '‚Äî') + '</td>';
    lbBody.appendChild(tr);
  });

  // Entry browser
  function scoreClass(s) { return s >= 65 ? 'score-high' : s >= 30 ? 'score-mid' : 'score-low'; }

  function renderEntries(list) {
    var tbody = document.querySelector('#entries-table tbody');
    tbody.innerHTML = '';
    list.forEach(function(e) {
      var fcs = e.fcs && e.fcs.score ? e.fcs.score.total : null;
      var tier = e.fcs && e.fcs.lifecycle ? e.fcs.lifecycle.tier : 'seedling';
      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td>' + (TYPE_EMOJI[e.type] || 'üì¶') + ' ' + e.type + '</td>' +
        '<td>' + e.id + '</td>' +
        '<td>' + e.name + '</td>' +
        '<td>' + (fcs !== null ? '<span class="score ' + scoreClass(fcs) + '">' + fcs.toFixed(0) + '</span>' : '‚Äî') + '</td>' +
        '<td class="tier">' + (TIER_LABEL[tier] || tier) + '</td>' +
        '<td>' + e.author + '</td>' +
        '<td>' + (e.updatedAt || '').slice(0, 10) + '</td>';
      tbody.appendChild(tr);
    });
  }

  renderEntries(entries);

  function applyFilters() {
    var type = document.getElementById('filter-type').value;
    var lifecycle = document.getElementById('filter-lifecycle').value;
    var search = document.getElementById('filter-search').value.toLowerCase();
    var filtered = entries.filter(function(e) {
      if (type && e.type !== type) return false;
      if (lifecycle) {
        var tier = e.fcs && e.fcs.lifecycle ? e.fcs.lifecycle.tier : 'seedling';
        if (tier !== lifecycle) return false;
      }
      if (search) {
        var hay = (e.id + ' ' + e.name + ' ' + e.description + ' ' + (e.tags || []).join(' ')).toLowerCase();
        if (hay.indexOf(search) === -1) return false;
      }
      return true;
    });
    renderEntries(filtered);
  }

  document.getElementById('filter-type').addEventListener('change', applyFilters);
  document.getElementById('filter-lifecycle').addEventListener('change', applyFilters);
  document.getElementById('filter-search').addEventListener('input', applyFilters);

  // Timeline chart
  if (typeof Chart !== 'undefined' && entries.length > 0) {
    var dates = entries.map(function(e) { return (e.createdAt || '').slice(0, 7); }).filter(Boolean);
    var uniqueMonths = Array.from(new Set(dates)).sort();
    var typeList = Object.keys(TYPE_LABELS);
    var datasets = typeList.map(function(t, i) {
      var colors = [ACCENT, '#2FBF71', '#FFB020', '#4A9EFF', '#E23D2D', '#8B7F77', '#FF7A50'];
      var cumulative = [];
      var count = 0;
      uniqueMonths.forEach(function(m) {
        count += entries.filter(function(e) { return e.type === t && (e.createdAt || '').slice(0, 7) <= m; }).length - (cumulative.length > 0 ? cumulative[cumulative.length - 1] : 0);
        if (cumulative.length > 0) count += cumulative[cumulative.length - 1];
        cumulative.push(count);
      });
      return {
        label: TYPE_LABELS[t],
        data: cumulative,
        borderColor: colors[i % colors.length],
        backgroundColor: 'transparent',
        tension: 0.3,
        pointRadius: 2
      };
    });

    var tlCtx = document.getElementById('timeline-chart').getContext('2d');
    new Chart(tlCtx, {
      type: 'line',
      data: { labels: uniqueMonths, datasets: datasets },
      options: {
        scales: {
          x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } },
          y: { beginAtZero: true, grid: { color: '#30363d' }, ticks: { color: '#8b949e', stepSize: 1 } }
        },
        plugins: { legend: { labels: { color: '#e6edf3' } } }
      }
    });
  }

  // Strategy performance
  var strategies = entries.filter(function(e) { return e.type === 'strategy' && e.fcs && e.fcs.backtest; });
  if (strategies.length > 0) {
    document.getElementById('strategy-section').style.display = '';
    var stBody = document.querySelector('#strategy-table tbody');
    strategies.forEach(function(e) {
      var bt = e.fcs.backtest;
      var fcs = e.fcs.score.total;
      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td>' + e.name + '</td>' +
        '<td><span class="score ' + scoreClass(fcs) + '">' + fcs.toFixed(0) + '</span></td>' +
        '<td>' + bt.sharpeRatio.toFixed(2) + '</td>' +
        '<td>' + bt.maxDrawdownPct.toFixed(1) + '%</td>' +
        '<td>' + bt.totalReturnPct.toFixed(1) + '%</td>' +
        '<td>' + bt.winRatePct.toFixed(0) + '%</td>' +
        '<td>' + bt.tradeCount + '</td>';
      stBody.appendChild(tr);
    });
  }
})();
</script>
</body>
</html>
