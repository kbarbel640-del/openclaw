services:
  openclaw-dind:
    # Rootless DIND reduces host risk vs privileged dockerd-in-docker.
    image: docker:27-dind-rootless
    environment:
      DOCKER_TLS_CERTDIR: ""
    command: ["--tls=false", "--host=tcp://0.0.0.0:2375"]
    volumes:
      - openclaw_dind:/home/rootless/.local/share/docker
      - openclaw_workspace:/openclaw/workspace
    restart: unless-stopped

  openclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    env_file:
      - ../.env
    environment:
      HOME: /home/node
      TERM: xterm-256color
      GIT_CONFIG_GLOBAL: /home/node/.openclaw/gitconfig
      OPENCLAW_INSTANCE: local
      SEARXNG_BASE_URL: ${SEARXNG_BASE_URL:-http://openclaw-searxng:8080}
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE}
      DOCKER_HOST: tcp://openclaw-dind:2375
    volumes:
      - openclaw_config:/home/node/.openclaw
      - openclaw_workspace:/openclaw/workspace
    depends_on:
      - openclaw-dind
    ports:
      - "127.0.0.1:${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      - "127.0.0.1:${OPENCLAW_BRIDGE_PORT:-18790}:18790"
    init: true
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    command:
      [
        "bash",
        "-lc",
        "exec node dist/index.js gateway --allow-unconfigured --bind ${OPENCLAW_GATEWAY_BIND:-lan} --port 18789",
      ]

  openclaw-cli:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    env_file:
      - ../.env
    environment:
      HOME: /home/node
      TERM: xterm-256color
      GIT_CONFIG_GLOBAL: /home/node/.openclaw/gitconfig
      OPENCLAW_INSTANCE: local
      SEARXNG_BASE_URL: ${SEARXNG_BASE_URL:-http://openclaw-searxng:8080}
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      BROWSER: echo
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE}
      DOCKER_HOST: tcp://openclaw-dind:2375
    volumes:
      - openclaw_config:/home/node/.openclaw
      - openclaw_workspace:/openclaw/workspace
    depends_on:
      - openclaw-dind
    stdin_open: true
    tty: true
    init: true
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    entrypoint:
      [
        "bash",
        "-lc",
        'exec node dist/index.js "$@"',
        "--",
      ]

  # Optional local meta-search endpoint for a tighter "internet sandbox" pattern.
  # Start with: docker compose --profile internet-sandbox up -d openclaw-searxng
  openclaw-searxng:
    image: searxng/searxng:latest
    profiles: ["internet-sandbox"]
    environment:
      BASE_URL: ${SEARXNG_PUBLIC_BASE_URL:-http://127.0.0.1:18080/}
      INSTANCE_NAME: OpenClaw Internet Sandbox
    volumes:
      - ./searxng/settings.yml:/etc/searxng/settings.yml
    ports:
      - "127.0.0.1:${SEARXNG_PORT:-18080}:8080"
    restart: unless-stopped

volumes:
  openclaw_dind:
  openclaw_config:
  openclaw_workspace:
