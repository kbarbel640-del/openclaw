# 無極系統架構

## 整體架構

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              外部服務                                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                          │
│  │ LINE    │  │Telegram │  │ Discord │  │ Browser │                          │
│  │ Server  │  │ Server  │  │ Server  │  │ (Chrome)│                          │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘                          │
│       │            │            │            │                               │
└───────┼────────────┼────────────┼────────────┼───────────────────────────────┘
        │            │            │            │
        │ webhook    │ polling    │ websocket  │ devtools
        ▼            ▼            ▼            ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                           本機環境 (macOS)                                    │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  Container: moltbot-core.router.wuji.01-stg                            │  │
│  │  Port: 18799 (內部) → 18789 (映射)                                      │  │
│  │                                                                        │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │  │
│  │  │  LINE        │  │  Telegram    │  │  Multi-Agent │                  │  │
│  │  │  Handler     │  │  Handler     │  │  ├─ bita     │                  │  │
│  │  │  (webhook)   │  │  (polling)   │  │  └─ xo       │                  │  │
│  │  └──────┬───────┘  └──────┬───────┘  └──────────────┘                  │  │
│  │         │                 │                                            │  │
│  │         ▼                 ▼                                            │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │  │
│  │  │                    Time Tunnel                                  │   │  │
│  │  │  SQLite: /app/workspace/data/timeline.db                        │   │  │
│  │  │  ├─ messages, identities, chats                                 │   │  │
│  │  │  └─ Level 100-103 意識表                                        │   │  │
│  │  └─────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                        │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │  │
│  │  │  Internal Hooks: time-tunnel, smart-router, cost-tracker        │   │  │
│  │  └─────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                        │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │  │
│  │  │  意識層: L0_wuji (戰略), L1_bita, L1_xo                         │   │  │
│  │  └─────────────────────────────────────────────────────────────────┘   │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  本機 Gateway (macOS LaunchAgent) - Port: 18789                        │  │
│  │  ✅ Discord, Browser Control  ❌ Telegram, LINE (Container 處理)       │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  輔助服務: exec-bridge(:18793), telegram-userbot(:18790), ngrok            │
└──────────────────────────────────────────────────────────────────────────────┘
```

## 關鍵規則

1. **LINE 回覆**：永遠不要用 message 工具，直接輸出讓 auto-reply 處理
2. **Telegram**：只有 Container 可以連接，本機禁用避免 getUpdates 衝突
3. **記憶查詢**：用戶問「你記得嗎」時，先查 Time Tunnel 再回答
4. **部署**：先 deploy-check.sh，再 zero-downtime-deploy.sh

## 工具腳本

| 腳本         | 用途              |
| ------------ | ----------------- |
| blackhole    | 跨 agent 記憶查詢 |
| unified-logs | 統一日誌查看      |
| monitor-429  | 429 錯誤監控      |
