#!/bin/bash
#
# ğŸ“Š UNIFIED-LOGS - çµ±ä¸€æ—¥èªŒæŸ¥çœ‹å™¨
#
# èšåˆæ‰€æœ‰æ—¥èªŒä½ç½®ï¼Œå–®ä¸€å‘½ä»¤æŸ¥çœ‹
#
# Usage:
#   ./unified-logs                    # é¡¯ç¤ºæ‰€æœ‰æ—¥èªŒä½ç½®
#   ./unified-logs tail               # tail -f æ‰€æœ‰æ´»èºæ—¥èªŒ
#   ./unified-logs errors [minutes]   # æœ€è¿‘ N åˆ†é˜çš„éŒ¯èª¤
#   ./unified-logs line               # LINE ç›¸é—œæ—¥èªŒ
#   ./unified-logs 429                # 429 éŒ¯èª¤çµ±è¨ˆ
#   ./unified-logs container          # Container æ—¥èªŒ
#

# é¡è‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

CONTAINER="moltbot-core.router.wuji.01-stg"

# æ—¥èªŒä½ç½®
GATEWAY_LOG="/tmp/gateway.log"
GATEWAY_ERR="$HOME/.openclaw/logs/gateway.err.log"
OPENCLAW_LOG="/tmp/openclaw/openclaw-$(date +%Y-%m-%d).log"
COST_LOG="$HOME/clawd/workspace/logs/cost.log"
FAILOVER_LOG="$HOME/clawd/workspace/logs/failover.log"

cmd_status() {
  echo -e "${CYAN}ğŸ“Š æ—¥èªŒä½ç½®ç¸½è¦½${NC}"
  echo ""

  echo -e "${YELLOW}æœ¬æ©Ÿ Gateway${NC}"
  [ -f "$GATEWAY_LOG" ] && echo "  âœ… $GATEWAY_LOG ($(du -h "$GATEWAY_LOG" 2>/dev/null | cut -f1))" || echo "  âŒ $GATEWAY_LOG"
  [ -f "$GATEWAY_ERR" ] && echo "  âœ… $GATEWAY_ERR ($(du -h "$GATEWAY_ERR" 2>/dev/null | cut -f1))" || echo "  âŒ $GATEWAY_ERR"
  [ -f "$OPENCLAW_LOG" ] && echo "  âœ… $OPENCLAW_LOG ($(du -h "$OPENCLAW_LOG" 2>/dev/null | cut -f1))" || echo "  âŒ $OPENCLAW_LOG"

  echo ""
  echo -e "${YELLOW}Hooks æ—¥èªŒ${NC}"
  [ -f "$COST_LOG" ] && echo "  âœ… $COST_LOG ($(du -h "$COST_LOG" 2>/dev/null | cut -f1))" || echo "  âŒ $COST_LOG"
  [ -f "$FAILOVER_LOG" ] && echo "  âœ… $FAILOVER_LOG ($(du -h "$FAILOVER_LOG" 2>/dev/null | cut -f1))" || echo "  âŒ $FAILOVER_LOG"

  echo ""
  echo -e "${YELLOW}Container${NC}"
  if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER}$"; then
    echo "  âœ… $CONTAINER é‹è¡Œä¸­"
    echo "     docker logs $CONTAINER --tail 50"
  else
    echo "  âŒ $CONTAINER æœªé‹è¡Œ"
  fi
}

cmd_tail() {
  echo -e "${CYAN}ğŸ“º å¯¦æ™‚æ—¥èªŒï¼ˆCtrl+C é€€å‡ºï¼‰${NC}"
  echo ""

  # ä½¿ç”¨ multitail å¦‚æœå¯ç”¨ï¼Œå¦å‰‡ç”¨ tail
  if command -v multitail &>/dev/null; then
    multitail "$GATEWAY_LOG" "$GATEWAY_ERR" 2>/dev/null
  else
    tail -f "$GATEWAY_LOG" "$GATEWAY_ERR" 2>/dev/null
  fi
}

cmd_errors() {
  local minutes="${1:-30}"
  echo -e "${CYAN}âŒ æœ€è¿‘ $minutes åˆ†é˜çš„éŒ¯èª¤${NC}"
  echo ""

  echo -e "${YELLOW}=== Gateway Errors ===${NC}"
  if [ -f "$GATEWAY_ERR" ]; then
    # è¨ˆç®—æ™‚é–“æˆ³
    local since=$(date -v-${minutes}M +%Y-%m-%dT%H:%M 2>/dev/null || date -d "$minutes minutes ago" +%Y-%m-%dT%H:%M 2>/dev/null)
    grep -i "error\|fail\|429" "$GATEWAY_ERR" 2>/dev/null | tail -30
  fi

  echo ""
  echo -e "${YELLOW}=== Container Errors ===${NC}"
  if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER}$"; then
    docker logs "$CONTAINER" --since "${minutes}m" 2>&1 | grep -i "error\|fail\|429" | tail -30
  fi
}

cmd_line() {
  echo -e "${CYAN}ğŸ“± LINE ç›¸é—œæ—¥èªŒ${NC}"
  echo ""

  echo -e "${YELLOW}=== æœ¬æ©Ÿ Gateway ===${NC}"
  grep -i "line" "$GATEWAY_LOG" 2>/dev/null | tail -20
  grep -i "line" "$GATEWAY_ERR" 2>/dev/null | tail -10

  echo ""
  echo -e "${YELLOW}=== Container ===${NC}"
  if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER}$"; then
    docker logs "$CONTAINER" --tail 500 2>&1 | grep -i "line" | tail -30
  fi
}

cmd_429() {
  echo -e "${CYAN}ğŸš« 429 éŒ¯èª¤çµ±è¨ˆ${NC}"
  echo ""

  echo -e "${YELLOW}=== ä»Šæ—¥çµ±è¨ˆ ===${NC}"
  local today_gateway=$(grep -c "429" "$GATEWAY_ERR" 2>/dev/null || echo 0)
  local today_container=$(docker logs "$CONTAINER" --since "24h" 2>&1 | grep -c "429" 2>/dev/null || echo 0)

  echo "  Gateway: $today_gateway æ¬¡"
  echo "  Container: $today_container æ¬¡"

  echo ""
  echo -e "${YELLOW}=== æœ€è¿‘ 429 éŒ¯èª¤ ===${NC}"
  docker logs "$CONTAINER" --tail 1000 2>&1 | grep "429" | tail -10
}

cmd_container() {
  echo -e "${CYAN}ğŸ³ Container æ—¥èªŒ${NC}"
  echo ""

  if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER}$"; then
    docker logs "$CONTAINER" --tail 100 2>&1
  else
    echo "Container æœªé‹è¡Œ"
  fi
}

# ä¸»å…¥å£
case "$1" in
  tail)
    cmd_tail
    ;;
  errors)
    cmd_errors "$2"
    ;;
  line)
    cmd_line
    ;;
  429)
    cmd_429
    ;;
  container)
    cmd_container
    ;;
  *)
    cmd_status
    ;;
esac
