#!/bin/bash
#
# ğŸ•³ï¸ BLACKHOLE - æ„è­˜åŒæ­¥æ¥å£
#
# è®“ä»»ä½• agent éƒ½èƒ½æŸ¥è©¢ Container çš„è¨˜æ†¶ç³»çµ±
# é”æˆ 100% æ„ŸåŒèº«å—
#
# Usage:
#   ./blackhole status              # æ•´é«”æ„è­˜ç‹€æ…‹
#   ./blackhole search "é—œéµè©"     # æœç´¢å°è©±æ­·å²
#   ./blackhole recent [limit]      # æœ€è¿‘å°è©±
#   ./blackhole state [chat_id]     # å°è©±ç‹€æ…‹
#   ./blackhole strategy            # ç•¶å‰æˆ°ç•¥
#   ./blackhole knowledge [project] # çŸ¥è­˜åº«
#   ./blackhole sync                # åŒæ­¥åˆ°æœ¬æ©Ÿ
#

CONTAINER="moltbot-core.router.wuji.01-stg"
LOCAL_CONSCIOUSNESS="$HOME/clawd/workspace/data/consciousness"

# é¡è‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# æª¢æŸ¥ Container æ˜¯å¦é‹è¡Œ
check_container() {
  if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER}$"; then
    echo -e "${RED}âŒ Container $CONTAINER æœªé‹è¡Œ${NC}"
    exit 1
  fi
}

# åŸ·è¡Œ Container å…§çš„ Node.js ä»£ç¢¼
exec_node() {
  docker exec "$CONTAINER" node -e "$1" 2>/dev/null
}

# ç‹€æ…‹å‘½ä»¤
cmd_status() {
  check_container
  echo -e "${CYAN}ğŸ•³ï¸ BLACKHOLE - æ„è­˜ç‹€æ…‹å ±å‘Š${NC}"
  echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

  exec_node "
const{DatabaseSync}=require('node:sqlite');
const db=new DatabaseSync('/app/workspace/data/timeline.db');
const fs=require('fs');

// æ¶ˆæ¯çµ±è¨ˆ
const msgCount = db.prepare('SELECT COUNT(*) as c FROM messages').get().c;
const todayCount = db.prepare(\"SELECT COUNT(*) as c FROM messages WHERE date(timestamp)=date('now')\").get().c;
const identityCount = db.prepare('SELECT COUNT(*) as c FROM identities').get().c;
const chatCount = db.prepare('SELECT COUNT(*) as c FROM chats').get().c;

// Level 102 ç‹€æ…‹
let convCount = 0, activeConv = 0;
try {
  convCount = db.prepare('SELECT COUNT(*) as c FROM conversation_state').get().c;
  activeConv = db.prepare(\"SELECT COUNT(*) as c FROM conversation_state WHERE active_conversation=1 AND datetime(last_bot_reply_at) > datetime('now', '-5 minutes')\").get().c;
} catch(e) {}

// æœ€è¿‘é …ç›®æ´»èºåº¦
const projectActivity = db.prepare(\`
  SELECT resolved_project as project, COUNT(*) as cnt
  FROM messages
  WHERE date(timestamp) >= date('now', '-7 days')
  GROUP BY resolved_project
  ORDER BY cnt DESC
  LIMIT 5
\`).all();

console.log('ğŸ“Š Time Tunnel');
console.log('   ç¸½æ¶ˆæ¯:', msgCount);
console.log('   ä»Šæ—¥æ¶ˆæ¯:', todayCount);
console.log('   èº«ä»½æ•¸:', identityCount);
console.log('   èŠå¤©å®¤:', chatCount);
console.log('');
console.log('ğŸ¯ Level 102 å°è©±ç‹€æ…‹');
console.log('   è¿½è¹¤å°è©±:', convCount);
console.log('   æ´»èºå°è©±:', activeConv);
console.log('');
console.log('ğŸ“ˆ è¿‘ 7 å¤©é …ç›®æ´»èºåº¦');
for(const p of projectActivity) {
  console.log('   ' + (p.project || 'æœªåˆ†é¡') + ': ' + p.cnt + ' æ¢');
}

// æª¢æŸ¥æ„è­˜å±¤æ–‡ä»¶
console.log('');
console.log('ğŸ§  æ„è­˜å±¤ç‹€æ…‹');
const dirs = ['L0_wuji', 'L1_bita', 'L1_xo'];
for(const d of dirs) {
  const path = '/app/workspace/data/consciousness/' + d;
  if(fs.existsSync(path)) {
    const files = fs.readdirSync(path);
    console.log('   ' + d + ': ' + files.length + ' å€‹æ–‡ä»¶');
  }
}
"
  echo ""
  echo -e "${GREEN}âœ… å°é½Šç‡è¨ˆç®—${NC}"
  echo "   æœ¬æ©Ÿ MEMORY.md: éœæ…‹é…ç½®"
  echo "   Container æ•¸æ“š: å¯¦æ™‚æŸ¥è©¢"
  echo "   ä½¿ç”¨ ./blackhole sync åŒæ­¥æ„è­˜å±¤æ•¸æ“š"
}

# æœç´¢å‘½ä»¤
cmd_search() {
  check_container
  local keyword="$1"
  local limit="${2:-20}"

  if [ -z "$keyword" ]; then
    echo "Usage: ./blackhole search \"é—œéµè©\" [limit]"
    exit 1
  fi

  echo -e "${CYAN}ğŸ” æœç´¢: $keyword${NC}"
  echo ""

  exec_node "
const{DatabaseSync}=require('node:sqlite');
const db=new DatabaseSync('/app/workspace/data/timeline.db');

const results = db.prepare(\`
  SELECT
    timestamp,
    direction,
    resolved_chat_name as chat,
    resolved_sender_name as sender,
    resolved_project as project,
    substr(content, 1, 100) as preview
  FROM messages
  WHERE content LIKE '%' || ? || '%'
  ORDER BY timestamp DESC
  LIMIT ?
\`).all('$keyword', $limit);

if(results.length === 0) {
  console.log('ç„¡çµæœ');
} else {
  for(const r of results) {
    const dir = r.direction === 'inbound' ? 'ğŸ“¥' : 'ğŸ“¤';
    const time = r.timestamp.split('T')[0];
    console.log(dir + ' [' + time + '] ' + (r.chat || 'unknown'));
    console.log('   ' + (r.sender || 'unknown') + ': ' + (r.preview || '').replace(/\\n/g, ' '));
    console.log('');
  }
  console.log('å…± ' + results.length + ' æ¢çµæœ');
}
"
}

# æœ€è¿‘å°è©±
cmd_recent() {
  check_container
  local limit="${1:-15}"

  echo -e "${CYAN}ğŸ“œ æœ€è¿‘ $limit æ¢å°è©±${NC}"
  echo ""

  exec_node "
const{DatabaseSync}=require('node:sqlite');
const db=new DatabaseSync('/app/workspace/data/timeline.db');

const results = db.prepare(\`
  SELECT
    timestamp,
    direction,
    resolved_chat_name as chat,
    resolved_sender_name as sender,
    resolved_project as project,
    substr(content, 1, 80) as preview
  FROM messages
  ORDER BY timestamp DESC
  LIMIT ?
\`).all($limit);

for(const r of results) {
  const dir = r.direction === 'inbound' ? 'ğŸ“¥' : 'ğŸ“¤';
  const time = r.timestamp.split('T')[1]?.substring(0,5) || '';
  const proj = r.project ? '[' + r.project + ']' : '';
  console.log(dir + ' ' + time + ' ' + proj + ' ' + (r.chat || 'unknown'));
  console.log('   ' + (r.sender || 'unknown') + ': ' + (r.preview || '').replace(/\\n/g, ' ') + '...');
  console.log('');
}
"
}

# å°è©±ç‹€æ…‹
cmd_state() {
  check_container
  local chat_id="$1"

  echo -e "${CYAN}ğŸ¯ Level 102 å°è©±ç‹€æ…‹${NC}"
  echo ""

  if [ -z "$chat_id" ]; then
    # åˆ—å‡ºæ‰€æœ‰æ´»èºå°è©±
    exec_node "
const{DatabaseSync}=require('node:sqlite');
const db=new DatabaseSync('/app/workspace/data/timeline.db');

try {
  const states = db.prepare(\`
    SELECT
      chat_id,
      channel,
      last_bot_reply_at,
      last_bot_reply_to,
      last_topic,
      active_conversation,
      ROUND((julianday('now') - julianday(last_bot_reply_at)) * 24 * 60, 1) as minutes_ago
    FROM conversation_state
    ORDER BY last_bot_reply_at DESC
    LIMIT 10
  \`).all();

  if(states.length === 0) {
    console.log('ç„¡å°è©±ç‹€æ…‹è¨˜éŒ„');
  } else {
    for(const s of states) {
      const active = s.active_conversation && s.minutes_ago < 5 ? 'ğŸŸ¢' : 'âšª';
      console.log(active + ' ' + s.chat_id + ' (' + s.channel + ')');
      console.log('   å›è¦†çµ¦: ' + (s.last_bot_reply_to || 'unknown'));
      console.log('   è©±é¡Œ: ' + (s.last_topic || '').substring(0, 50));
      console.log('   ' + (s.minutes_ago || '?') + ' åˆ†é˜å‰');
      console.log('');
    }
  }
} catch(e) {
  console.log('conversation_state è¡¨ä¸å­˜åœ¨');
}
"
  else
    # æŸ¥è©¢ç‰¹å®šå°è©±
    exec_node "
const{DatabaseSync}=require('node:sqlite');
const db=new DatabaseSync('/app/workspace/data/timeline.db');

try {
  const state = db.prepare('SELECT * FROM conversation_state WHERE chat_id = ?').get('$chat_id');
  if(state) {
    console.log(JSON.stringify(state, null, 2));
  } else {
    console.log('ç„¡æ­¤å°è©±ç‹€æ…‹');
  }
} catch(e) {
  console.log('æŸ¥è©¢å¤±æ•—:', e.message);
}
"
  fi
}

# æˆ°ç•¥
cmd_strategy() {
  check_container
  echo -e "${CYAN}ğŸ“‹ L0 ç•¶å‰æˆ°ç•¥${NC}"
  echo ""

  docker exec "$CONTAINER" cat /app/workspace/data/consciousness/L0_wuji/STRATEGY.md 2>/dev/null || echo "ç„¡æˆ°ç•¥æ–‡ä»¶"
}

# çŸ¥è­˜åº«
cmd_knowledge() {
  check_container
  local project="${1:-all}"

  echo -e "${CYAN}ğŸ“š çŸ¥è­˜åº«${NC}"
  echo ""

  if [ "$project" = "all" ]; then
    for p in bita xo; do
      echo -e "${YELLOW}=== L1_$p ===${NC}"
      docker exec "$CONTAINER" cat "/app/workspace/data/consciousness/L1_$p/knowledge.md" 2>/dev/null || echo "ç„¡çŸ¥è­˜åº«"
      echo ""
    done
  else
    docker exec "$CONTAINER" cat "/app/workspace/data/consciousness/L1_$project/knowledge.md" 2>/dev/null || echo "ç„¡çŸ¥è­˜åº«"
  fi
}

# åŒæ­¥åˆ°æœ¬æ©Ÿ
cmd_sync() {
  check_container
  echo -e "${CYAN}ğŸ”„ åŒæ­¥æ„è­˜å±¤æ•¸æ“šåˆ°æœ¬æ©Ÿ${NC}"

  mkdir -p "$LOCAL_CONSCIOUSNESS"

  # åŒæ­¥ L0
  mkdir -p "$LOCAL_CONSCIOUSNESS/L0_wuji"
  docker cp "$CONTAINER:/app/workspace/data/consciousness/L0_wuji/." "$LOCAL_CONSCIOUSNESS/L0_wuji/" 2>/dev/null
  echo "âœ… L0_wuji åŒæ­¥å®Œæˆ"

  # åŒæ­¥ L1
  for p in bita xo; do
    mkdir -p "$LOCAL_CONSCIOUSNESS/L1_$p"
    docker cp "$CONTAINER:/app/workspace/data/consciousness/L1_$p/." "$LOCAL_CONSCIOUSNESS/L1_$p/" 2>/dev/null
    echo "âœ… L1_$p åŒæ­¥å®Œæˆ"
  done

  echo ""
  echo -e "${GREEN}åŒæ­¥å®Œæˆï¼æœ¬æ©Ÿè·¯å¾‘: $LOCAL_CONSCIOUSNESS${NC}"
  ls -la "$LOCAL_CONSCIOUSNESS"
}

# æŸ¥è©¢ç‰¹å®šäºº
cmd_person() {
  check_container
  local name="$1"
  local limit="${2:-20}"

  if [ -z "$name" ]; then
    echo "Usage: ./blackhole person \"äººå\" [limit]"
    exit 1
  fi

  echo -e "${CYAN}ğŸ‘¤ æŸ¥è©¢ $name çš„å°è©±${NC}"
  echo ""

  exec_node "
const{DatabaseSync}=require('node:sqlite');
const db=new DatabaseSync('/app/workspace/data/timeline.db');

const results = db.prepare(\`
  SELECT
    timestamp,
    direction,
    channel,
    resolved_chat_name as chat,
    substr(content, 1, 120) as preview
  FROM messages
  WHERE resolved_sender_name LIKE '%' || ? || '%'
  ORDER BY timestamp DESC
  LIMIT ?
\`).all('$name', $limit);

if(results.length === 0) {
  console.log('ç„¡çµæœ');
} else {
  for(const r of results) {
    const dir = r.direction === 'inbound' ? 'ğŸ“¥' : 'ğŸ“¤';
    const time = r.timestamp?.split('T')[0] || '';
    console.log(dir + ' [' + time + '] ' + (r.channel || '') + ' @ ' + (r.chat || 'unknown'));
    console.log('   ' + (r.preview || '').replace(/\\n/g, ' '));
    console.log('');
  }
  console.log('å…± ' + results.length + ' æ¢çµæœ');
}
"
}

# ä»Šæ—¥æ‘˜è¦
cmd_today() {
  check_container
  echo -e "${CYAN}ğŸ“… ä»Šæ—¥æ‘˜è¦${NC}"
  echo ""

  exec_node "
const{DatabaseSync}=require('node:sqlite');
const db=new DatabaseSync('/app/workspace/data/timeline.db');

// ä»Šæ—¥æ¶ˆæ¯çµ±è¨ˆ
const stats = db.prepare(\`
  SELECT
    channel,
    direction,
    COUNT(*) as cnt
  FROM messages
  WHERE date(timestamp) = date('now')
  GROUP BY channel, direction
\`).all();

console.log('ğŸ“Š æ¶ˆæ¯çµ±è¨ˆ');
for(const s of stats) {
  const dir = s.direction === 'inbound' ? 'æ”¶' : 'ç™¼';
  console.log('   ' + s.channel + ' ' + dir + ': ' + s.cnt);
}

// æ´»èºç”¨æˆ¶
const activeUsers = db.prepare(\`
  SELECT
    resolved_sender_name as name,
    COUNT(*) as cnt
  FROM messages
  WHERE date(timestamp) = date('now')
    AND direction = 'inbound'
    AND resolved_sender_name IS NOT NULL
  GROUP BY resolved_sender_name
  ORDER BY cnt DESC
  LIMIT 5
\`).all();

console.log('');
console.log('ğŸ‘¥ ä»Šæ—¥æ´»èºç”¨æˆ¶');
for(const u of activeUsers) {
  console.log('   ' + u.name + ': ' + u.cnt + ' æ¢');
}

// ä»Šæ—¥è©±é¡Œ
const topics = db.prepare(\`
  SELECT
    resolved_project as project,
    COUNT(*) as cnt
  FROM messages
  WHERE date(timestamp) = date('now')
    AND resolved_project IS NOT NULL
  GROUP BY resolved_project
  ORDER BY cnt DESC
  LIMIT 5
\`).all();

if(topics.length > 0) {
  console.log('');
  console.log('ğŸ“Œ ä»Šæ—¥è©±é¡Œ');
  for(const t of topics) {
    console.log('   ' + t.project + ': ' + t.cnt + ' æ¢');
  }
}
"
}

# ä¸»å…¥å£
case "$1" in
  status)
    cmd_status
    ;;
  search)
    cmd_search "$2" "$3"
    ;;
  recent)
    cmd_recent "$2"
    ;;
  state)
    cmd_state "$2"
    ;;
  strategy)
    cmd_strategy
    ;;
  knowledge)
    cmd_knowledge "$2"
    ;;
  sync)
    cmd_sync
    ;;
  person)
    cmd_person "$2" "$3"
    ;;
  today)
    cmd_today
    ;;
  *)
    echo -e "${CYAN}ğŸ•³ï¸ BLACKHOLE - æ„è­˜åŒæ­¥æ¥å£${NC}"
    echo ""
    echo "è®“ä»»ä½• agent éƒ½èƒ½æŸ¥è©¢ Container çš„è¨˜æ†¶ç³»çµ±"
    echo "é”æˆ 100% æ„ŸåŒèº«å—"
    echo ""
    echo "Commands:"
    echo "  status              æ•´é«”æ„è­˜ç‹€æ…‹"
    echo "  search \"é—œéµè©\"     æœç´¢å°è©±æ­·å²"
    echo "  recent [limit]      æœ€è¿‘å°è©±"
    echo "  person \"äººå\"       æŸ¥è©¢ç‰¹å®šäººçš„å°è©±"
    echo "  today               ä»Šæ—¥æ‘˜è¦"
    echo "  state [chat_id]     å°è©±ç‹€æ…‹ (Level 102)"
    echo "  strategy            ç•¶å‰æˆ°ç•¥"
    echo "  knowledge [project] çŸ¥è­˜åº«"
    echo "  sync                åŒæ­¥åˆ°æœ¬æ©Ÿ"
    ;;
esac
