# 2026-02-05 記憶存檔

## BG666 首充來源分析（完成）

### 需求背景
- **發起人**：Momo（在 Lark 666产运群）
- **需求**：想知道首充用户的来源，哪个板块/渠道在贡献
- **杜甫角色**：接下分析任務，用數據回答

### 最終口徑（已與 Momo 確認）
- **首充定義**：第一次充值成功（`player_recharge_order.order_status=1` 的首筆），不限註冊月份
- **渠道維度**：`sys_player.channel_id`（acquisition 渠道，不是支付通道）
- **對比區間**：近30天（2026-01-06~02-05）vs 前30天（2025-12-07~01-05）

### 分析結果
- **總體**：近30天首充 15,641 人 vs 前30天 15,687 人，-46 人（-0.3%），基本持平
- **Top 拉升渠道**：62（+836人）、59（+601人）、60（+522人）
- **Top 下滑渠道**：12（-779人）、40（-224人）、20（-191人）
- **關鍵發現**：
  - 渠道 12（最大渠道）首充人數下滑但首充率反升 → 註冊量下降導致
  - 渠道 62/60 是新增長點（量率雙漲）
  - 渠道 59 量漲率跌（需關注質量）

### 產出物
- CSV：`~/clawd/output/bg666_first_recharge_by_channel.csv`

---

## 工作方法學習

### 厚黑學回覆提案（杜甫反饋）
- 我給了 3 個回覆提案（穩住關係 / 搶專業主導權 / 防需求膨脹）
- **杜甫反饋**：「你搞這麼複雜，還是我自己回的好一點」
- **教訓**：不要過度設計，簡單直接最有效。杜甫只需要一句話能回的版本。

### Momo 的「你更专业」
- Momo 回「后面口径你来定哦 你更专业」= 把定義責任丟回來
- 杜甫處理方式：接住責任 + 鎖死交付時間（「今天給表」）

---

## 技術筆記

### BG666 DB Schema（重要表）
1. `sys_player`：玩家主表，有 `channel_id`（acquisition 渠道）
2. `player_recharge_order`：充值訂單，有 `order_status`（0待支付/1成功/2失敗/3超時/4異常）
   - 注意：此表的 `channel_id` 是「支付通道 id」，不是 acquisition channel
3. `channel_data_statistics`：渠道日統計（已聚合），有 `first_recharge_number`
4. `first_deposit_record`：首充贈送記錄（不是首充定義本身）

### ZeroTier 連線問題
- 今天遇到 ZeroTier 沒有加入 BG666 網絡的問題
- 解法：`sudo zerotier-cli join 48d6023c4641dcad`
- 現象：`zerotier-cli listnetworks` 顯示空 = 沒有加入任何網絡

---

## Lark 能力確認
- 可以用瀏覽器自動化讀取 Lark Messenger
- API 權限：發消息（Bot）✅、讀任務/文檔/日曆 ✅、讀 IM 聊天消息 ❌（需申請）

### [20:31] 📸 即時記錄
- **觸發**：指令/數據
- **誰**：Cruz Tang
- **內容**：要求把 commit 與 diff 寫入記憶（flipflop-travel）
- **行動**：記錄提交 `feat: add visa/voucher fees and batch update` 與變更摘要。 

### [20:31] 📸 即時記錄
- **觸發**：數據
- **誰**：系統
- **內容**：flipflop-travel 已 push
- **行動**：記錄 commit 與 diff 摘要如下。

#### flipflop-travel commit
- **Commit**：`ac9762f` — `feat: add visa/voucher fees and batch update`
- **內容摘要**：新增簽證/票券費用欄位、批次套用費用 API/前端、更新扣款順序、調整 schema/migration。已 push 到 `main`。

#### diff 摘要
- `db/schema-flipflop.sql`：members 新增 `visa_amount`、`voucher_amount`；補齊費用欄位與註解；total 改為預設 0。
- `db/migrations/003_add_visa_voucher_amounts.sql`：新增 migration。
- `api/members/update.js`：支援 visa/voucher 金額、總額計算更新。
- `api/members/list.js`：回傳 visa/voucher、總額計算更新。
- `api/members/my_status.js`：扣款順序改為 `機票 > 簽證 > 住宿 > 包車 > 票券 > 網卡`。
- `api/members/batch_update.js`：新增批次更新費用 API（只改勾選欄位，重算 total）。
- `src/components/members/EditMemberForm.jsx`：新增簽證/票券欄位與驗證。
- `src/components/members/MemberCard.jsx`：顯示簽證/票券明細。
- `src/components/members/BatchFeeForm.jsx`：新增批次套用 UI。
- `src/pages/TripManagePage.jsx`：新增「設定預設費用」入口與串接。

#### 其他
- `.env` 修正 shell 語法：移除多餘 `$`，`POSTGRES_PRISMA_URL` 加引號（避免 `source` 解析錯誤）。

### [20:32] 📸 即時記錄
- **觸發**：指令
- **誰**：Cruz Tang
- **內容**：詢問如何在另一個 session 讓產品經理回憶並報告已完成更新
- **行動**：提供可直接貼的指令與記憶檔案位置。
