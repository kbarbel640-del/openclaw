# 幣塔日報金流口徑問題分析

**日期**：2026-02-02
**觸發**：Z 的 2/1 日報金額 $27,623,290 無法與校準群記錄對上

---

## 已理解的部分

### 日報產出流程
1. `daily_report.py` 每天跑一次
2. 用 Telegram bridge 拉取每位員工群組的訊息
3. **下載截圖** → 送 Gemini Vision (`hybrid_analyzer.py`) 分析
4. Gemini 回傳 JSON：`{type, method, amount, status, funnel_stage, summary}`
5. 存入 `conversations` 表
6. 統計成交：`SELECT DISTINCT tx_type, tx_amount WHERE is_transaction=1 AND tx_status='完成'`
7. 產出日報發到管理群

### 去重邏輯
```sql
SELECT COUNT(*), SUM(amount) FROM (
    SELECT DISTINCT tx_type, tx_amount
    FROM conversations
    WHERE is_transaction=1 AND tx_status='完成'
)
```
**問題**：只用 `tx_type + tx_amount` 去重，同類型同金額的不同交易會被合併！

### 金額來源
- **Gemini Vision 自己看截圖判斷金額**
- 沒有人工校驗，沒有統一口徑指引
- Gemini 有時讀到 TWD 金額（如 $1,000、$3,000）
- 有時讀到遊戲幣值（如 $14,400,000、$22,100,000）
- **同一筆交易多張截圖 → 被記成多筆**

---

## 確認的問題

### ❌ 問題 1：金額口徑不統一
Gemini 看截圖時，**不知道該記 TWD 還是遊戲幣值**。

| 交易 | Gemini 記的金額 | 實際 TWD | 實際遊戲幣 |
|------|----------------|---------|-----------|
| 田佑升 買幣 | $2,470 | $1,900 | 2,470 |
| 鹹鹹 出金 | $10,000 | $10,000 | 1,440,000 |
| 張啊韋 出金 | $14,400,000 | $1,000 | 14,400,000 |
| Cheng 出金 | ? | $1,700 | 22,100,000 |

**→ 需要確認：日報的「金額」到底要統一用什麼單位？**

### ❌ 問題 2：重複記錄
同一筆交易的多張截圖被 Gemini 各自分析，產生重複記錄：
- 田佑升買幣：#334 出金 $2,470 + #335 儲值 $2,470 + #336 儲值 $1,900 → **3 筆**
- 鹹鹹出金：#337 出金 $10,000 + #338 出金 $10,000 + #339 出金 $10,000 → **3 筆**
- 少年董：#329 #330 #331 都是 $1,000 儲值 → **3 筆**

去重邏輯 `DISTINCT tx_type, tx_amount` 能合併同類型同金額的，但：
- 同一會員的兩筆真正不同交易（恰好同金額）會被錯誤合併
- 不同會員的同金額交易也會被合併

### ❌ 問題 3：缺少交易識別資訊
`conversations` 表沒有記錄：
- **會員名稱**（誰買的）
- **遊戲平台**（哪個遊戲）
- **匯率**（買入/回收）
- **交易對象帳號**（遊戲帳號）

這些資訊在截圖裡都有，但 Gemini prompt 沒要求提取。

---

## 需要跟客服確認的問題（填充題）

### 📋 金流基礎知識

**Q1**：幣塔的交易金額，內部記帳是用 _____ 為單位？
- [ ] 台幣 (TWD)
- [ ] 遊戲幣值
- [ ] 其他：_____

**Q2**：「買幣」的完整流程是：
客戶說要買 → 客服給 _____ → 客戶付 _____(TWD) → 客服贈送 _____(遊戲幣) → 完成

**Q3**：「賣幣」的完整流程是：
客戶說要賣 → 客服收回 _____(遊戲幣) → 客服轉帳 _____(TWD) → 完成

**Q4**：匯率說明 — 以「我要賺Online」為例：
- 買入匯率 132 的意思是：客戶付 1 TWD，得到 _____ 遊戲幣
- 回收匯率 144 的意思是：客戶賣回 _____ 遊戲幣，得到 1 TWD

**Q5**：以「天狐宴」為例：
- 買入匯率 13,000 的意思是：_____
- 回收匯率 14,400 的意思是：_____

**Q6**：那些匯率 1.3 的遊戲（如少年董、田佑升的交易），是什麼遊戲？匯率 1.3 的意思是 _____

### 📋 日報口徑

**Q7**：日報上「金額」那欄，你們希望看到的是：
- [ ] 客戶實際付出/收到的台幣金額
- [ ] 遊戲幣數量
- [ ] 台幣 × 匯率的計算結果
- [ ] 其他：_____

**Q8**：一筆完整交易（從客戶開口到完成），通常會產生幾張截圖？_____
（目前 Gemini 每張截圖都記一筆，導致重複）

**Q9**：員工回報時，有固定的結案格式嗎？比如「完成」截圖長什麼樣？
- [ ] 有固定格式：_____
- [ ] 沒有，看員工習慣

**Q10**：「活動申請」（如周加碼 500）算不算在「成交」裡面？
- [ ] 算
- [ ] 不算

---

## 建議修復方案（確認口徑後執行）

1. **Gemini prompt 升級**：要求提取會員名、遊戲、匯率、TWD 金額、遊戲幣值（分開欄位）
2. **DB schema 升級**：加 `customer_name`, `game`, `rate`, `twd_amount`, `coin_amount` 欄位
3. **去重邏輯升級**：用 `customer_name + game + twd_amount` 去重，或用時間窗口歸組
4. **交易歸組**：同一筆交易的多張截圖歸為一組（用 conversation_id 或時間窗口）
