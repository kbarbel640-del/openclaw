apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "openclaw.fullname" . }}-gateway-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openclaw.gateway.labels" . | nindent 4 }}
data:
  openclaw.json: |
    {
      "gateway": {
        "mode": "local",
        "port": {{ .Values.gateway.port }},
        "bind": "lan",
        "auth": {
          "mode": "token"
          {{- if .Values.gateway.k8sTrust.enabled }},
          "k8sTrust": {
            "enabled": true,
            "allowedIdentities": [
              {{- range $index, $identity := .Values.gateway.k8sTrust.allowedIdentities }}
              {{- if $index }},{{- end }}
              {
                "namespace": {{ tpl $identity.namespace $ | quote }},
                "serviceAccount": {{ tpl $identity.serviceAccount $ | quote }},
                "allowedRoles": {{ $identity.allowedRoles | toJson }}
              }
              {{- end }}
            ],
            "ephemeralSessions": {{ .Values.gateway.k8sTrust.ephemeralSessions }},
            "auditLog": {{ .Values.gateway.k8sTrust.auditLog }}
          }
          {{- end }}
        }
      }
      {{- if .Values.gateway.agentModel }},
      "agents": {
        "defaults": {
          "model": {
            "primary": {{ .Values.gateway.agentModel | quote }}
          }
        }
      }
      {{- end }}
      {{- if and .Values.gateway.telegram .Values.gateway.telegram.enabled }},
      "channels": {
        "telegram": {
          "enabled": true,
          "dmPolicy": {{ .Values.gateway.telegram.dmPolicy | default "allowlist" | quote }},
          "allowFrom": {{ .Values.gateway.telegram.allowFrom | toJson }}
        }
      },
      "plugins": {
        "entries": {
          "telegram": {
            "enabled": true
          }
        }
      }
      {{- end }}
    }
