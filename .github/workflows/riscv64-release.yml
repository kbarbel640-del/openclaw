name: RISC-V Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Upstream tag to build (e.g. v2026.2.23)'
        required: true
        type: string

concurrency:
  group: riscv64-release-${{ inputs.tag || github.ref_name }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-riscv64:
    name: Build riscv64 Docker image
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      packages: write
      contents: read
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.version.outputs.value }}
    steps:
      - name: Resolve version
        id: version
        shell: bash
        env:
          INPUT_TAG: ${{ inputs.tag }}
        run: |
          if [ -n "$INPUT_TAG" ]; then
            echo "value=$INPUT_TAG" >> "$GITHUB_OUTPUT"
          else
            echo "value=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.version.outputs.value }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: riscv64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve image tags
        id: tags
        shell: bash
        env:
          IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          VERSION: ${{ steps.version.outputs.value }}
        run: |
          set -euo pipefail
          version="${VERSION#v}"
          tags=("${IMAGE}:${version}-riscv64" "${IMAGE}:riscv64")
          {
            echo "value<<EOF"
            printf "%s\n" "${tags[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build and push riscv64 image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.riscv64
          platforms: linux/riscv64
          tags: ${{ steps.tags.outputs.value }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Disabled to avoid cross-platform manifest-list issues with GHCR;
          # revisit when buildx multi-platform provenance is stable for riscv64
          provenance: false
          push: true

  release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs: [build-riscv64]
    permissions:
      contents: write
    steps:
      - name: Resolve version
        id: version
        shell: bash
        env:
          BUILD_VERSION: ${{ needs.build-riscv64.outputs.version }}
        run: |
          echo "tag=${BUILD_VERSION}" >> "$GITHUB_OUTPUT"
          echo "name=${BUILD_VERSION#v}" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.version.outputs.tag }}
          fetch-depth: 1

      - name: Resolve target commit
        id: target
        shell: bash
        run: |
          sha=$(git rev-parse HEAD)
          echo "sha=${sha}" >> "$GITHUB_OUTPUT"

      - name: Check if release exists
        id: check
        shell: bash
        env:
          RELEASE_TAG: ${{ steps.version.outputs.tag }}-riscv64
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view "$RELEASE_TAG" --repo "${{ github.repository }}" &>/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Delete existing release
        if: steps.check.outputs.exists == 'true'
        env:
          RELEASE_TAG: ${{ steps.version.outputs.tag }}-riscv64
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release delete "$RELEASE_TAG" \
            --repo "${{ github.repository }}" --yes --cleanup-tag

      - name: Create release
        shell: bash
        env:
          RELEASE_TAG: ${{ steps.version.outputs.tag }}-riscv64
          RELEASE_NAME: ${{ steps.version.outputs.name }}
          UPSTREAM_TAG: ${{ steps.version.outputs.tag }}
          TARGET_SHA: ${{ steps.target.outputs.sha }}
          GH_TOKEN: ${{ github.token }}
        run: |
          cat > notes.md << NOTES
          ## RISC-V Docker Image

          Automated RISC-V (riscv64) build tracking upstream release.

          ### Docker
          \`\`\`bash
          docker pull ghcr.io/${{ github.repository }}:${RELEASE_NAME}-riscv64
          \`\`\`

          ### Upstream
          - **Release**: [${UPSTREAM_TAG}](https://github.com/openclaw/openclaw/releases/tag/${UPSTREAM_TAG})
          NOTES

          gh release create "$RELEASE_TAG" \
            --repo "${{ github.repository }}" \
            --title "RISC-V ${RELEASE_NAME}" \
            --target "$TARGET_SHA" \
            --notes-file notes.md

      - name: Summary
        env:
          RELEASE_NAME: ${{ steps.version.outputs.name }}
          IMAGE_DIGEST: ${{ needs.build-riscv64.outputs.image-digest }}
        run: |
          {
            echo "## RISC-V Release"
            echo ""
            echo "**Version**: ${RELEASE_NAME}"
            echo "**Image**: \`ghcr.io/${{ github.repository }}:${RELEASE_NAME}-riscv64\`"
            echo "**Digest**: \`${IMAGE_DIGEST}\`"
          } >> "$GITHUB_STEP_SUMMARY"
