# Daily check: merge upstream openclaw/main into a test branch and run build + test.
# Opens an issue in this repo if merge conflicts or build/test failures are detected.
# See FORK-CHANGES.md "Phase 5" and .agent/workflows/update_clawdbot.md.
name: Upstream sync test

on:
  schedule:
    # Daily at 06:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch:

concurrency:
  group: upstream-sync-test
  cancel-in-progress: false

jobs:
  sync-test:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/openclaw/openclaw.git || true
          git fetch upstream main

      - name: Upstream preview (incoming commits + CHANGELOG)
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/main 2>/dev/null || echo "0")
          {
            echo "## Upstream preview"
            echo ""
            echo "**Incoming:** $BEHIND commit(s) (HEAD..upstream/main)"
            echo ""
            if [ "$BEHIND" -eq 0 ]; then
              echo "Nothing to pull."
            else
              echo "### Incoming commits"
              echo '```'
              git log HEAD..upstream/main --oneline --no-decorate
              echo '```'
              echo ""
              if git show upstream/main:CHANGELOG.md &>/dev/null; then
                echo "### CHANGELOG diff"
                echo '```diff'
                git diff HEAD..upstream/main -- CHANGELOG.md || true
                echo '```'
              fi
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Merge upstream/main
        id: merge
        run: |
          BRANCH="sync-test-$(date +%Y%m%d-%H%M%S)"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          git checkout -b "$BRANCH"
          if ! git merge upstream/main --no-edit; then
            echo "Merge conflict with upstream/main" > "$RUNNER_TEMP/failure_reason.txt"
            git diff --name-only --diff-filter=U > "$RUNNER_TEMP/conflicted_files.txt" 2>/dev/null || true
            exit 1
          fi

      - name: Identify clean vs conflicted commit range
        if: failure() && steps.merge.outputs.branch != ''
        run: |
          git merge --abort 2>/dev/null || true
          REF=$(git rev-parse HEAD)
          TOTAL=$(git rev-list --count HEAD..upstream/main 2>/dev/null || echo "0")
          if [ "$TOTAL" -eq 0 ]; then
            echo "clean_count=0" >> "$RUNNER_TEMP/clean_conflict_split.txt"
            echo "conflicted_count=0" >> "$RUNNER_TEMP/clean_conflict_split.txt"
            exit 0
          fi
          # Binary search: smallest N (1..TOTAL) such that merge of upstream/main~N succeeds.
          # Then the last N commits are "conflicted"; the rest merge cleanly.
          BEST_N=0
          lo=1
          hi=$TOTAL
          while [ "$lo" -le "$hi" ]; do
            mid=$(( (lo + hi) / 2 ))
            git merge --abort 2>/dev/null || true
            git reset --hard "$REF" 2>/dev/null || true
            if git merge "upstream/main~$mid" --no-edit 2>/dev/null; then
              BEST_N=$mid
              hi=$(( mid - 1 ))
              git reset --hard "$REF" 2>/dev/null || true
            else
              git merge --abort 2>/dev/null || true
              git reset --hard "$REF" 2>/dev/null || true
              lo=$(( mid + 1 ))
            fi
          done
          if [ "$BEST_N" -eq 0 ]; then
            CLEAN_COUNT=0
            CONFLICTED_COUNT=$TOTAL
            git log HEAD..upstream/main --oneline --no-decorate >> "$RUNNER_TEMP/conflicted_commits.txt" 2>/dev/null || true
          else
            CLEAN_COUNT=$(( TOTAL - BEST_N ))
            CONFLICTED_COUNT=$BEST_N
            git log "upstream/main~$BEST_N..upstream/main" --oneline --no-decorate >> "$RUNNER_TEMP/conflicted_commits.txt" 2>/dev/null || true
            git log "HEAD..upstream/main~$BEST_N" --oneline --no-decorate 2>/dev/null | head -50 >> "$RUNNER_TEMP/clean_commits.txt" || true
          fi
          echo "clean_count=$CLEAN_COUNT" >> "$RUNNER_TEMP/clean_conflict_split.txt"
          echo "conflicted_count=$CONFLICTED_COUNT" >> "$RUNNER_TEMP/clean_conflict_split.txt"
          {
            echo "## Clean vs conflicted commits"
            echo ""
            echo "- **Merge cleanly:** $CLEAN_COUNT commit(s)"
            echo "- **Introduce conflict(s):** $CONFLICTED_COUNT commit(s) at tip"
            echo ""
            if [ -s "$RUNNER_TEMP/conflicted_commits.txt" ]; then
              echo "### Conflicted commits"
              echo '```'
              cat "$RUNNER_TEMP/conflicted_commits.txt"
              echo '```'
            fi
            if [ -s "$RUNNER_TEMP/clean_commits.txt" ]; then
              echo ""
              echo "### Commits that merge cleanly (sample)"
              echo '```'
              cat "$RUNNER_TEMP/clean_commits.txt"
              echo '```'
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Setup Node environment
        if: success()
        uses: ./.github/actions/setup-node-env
        with:
          install-bun: "false"
          frozen-lockfile: "false"

      - name: Build and test
        if: success()
        run: |
          pnpm build && pnpm test || {
            echo "Build or test failed after merging upstream/main" > "$RUNNER_TEMP/failure_reason.txt"
            exit 1
          }
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Open issue on failure
        if: failure()
        run: |
          REASON="Merge or build/test failure"
          if [ -f "$RUNNER_TEMP/failure_reason.txt" ]; then
            REASON=$(cat "$RUNNER_TEMP/failure_reason.txt")
          fi
          CONFLICTED=""
          if [ -f "$RUNNER_TEMP/conflicted_files.txt" ] && [ -s "$RUNNER_TEMP/conflicted_files.txt" ]; then
            CONFLICTED=$'\n\n**Conflicted files:**\n```\n'"$(cat "$RUNNER_TEMP/conflicted_files.txt")"$'\n```\n\nEasiest way to resolve in Cursor: run `git fetch upstream && git merge upstream/main` locally so these files appear in your workspace, then bring this issue URL into Cursor and resolve the conflicts.'
          fi
          CLEAN_CONFLICT_SECTION=""
          if [ -f "$RUNNER_TEMP/clean_conflict_split.txt" ]; then
            CLEAN_COUNT=$(grep '^clean_count=' "$RUNNER_TEMP/clean_conflict_split.txt" | cut -d= -f2)
            CONFLICTED_COUNT=$(grep '^conflicted_count=' "$RUNNER_TEMP/clean_conflict_split.txt" | cut -d= -f2)
            CLEAN_CONFLICT_SECTION=$'\n\n**Clean vs conflicted commits:** '"$CLEAN_COUNT"' commit(s) merge cleanly; '"$CONFLICTED_COUNT"' commit(s) at the tip introduce the conflict(s).'
            if [ "$CLEAN_COUNT" -gt 0 ]; then
              CLEAN_CONFLICT_SECTION="$CLEAN_CONFLICT_SECTION"$'\n\nTo merge only the clean commits first: `git fetch upstream && git merge upstream/main~'"$CONFLICTED_COUNT"'` then merge or rebase the rest and resolve.'
            fi
            if [ -f "$RUNNER_TEMP/conflicted_commits.txt" ] && [ -s "$RUNNER_TEMP/conflicted_commits.txt" ]; then
              CLEAN_CONFLICT_SECTION="$CLEAN_CONFLICT_SECTION"$'\n\n**Conflicted commits (merge these last / resolve first):**\n```\n'"$(cat "$RUNNER_TEMP/conflicted_commits.txt")"$'\n```'
            fi
            if [ -f "$RUNNER_TEMP/clean_commits.txt" ] && [ -s "$RUNNER_TEMP/clean_commits.txt" ]; then
              CLEAN_CONFLICT_SECTION="$CLEAN_CONFLICT_SECTION"$'\n\n**Commits that merge cleanly (sample):**\n```\n'"$(cat "$RUNNER_TEMP/clean_commits.txt")"$'\n```'
            fi
          fi
          TITLE="Upstream sync test failed â€” $(date +%Y-%m-%d)"
          BODY="The daily upstream sync test failed.

          **Reason:** $REASON
          $CONFLICTED
          $CLEAN_CONFLICT_SECTION

          **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Integrate upstream manually when ready. You can bring this issue URL into Cursor to analyze; use the workflow run link above for full logs. Steps: [.agent/workflows/update_clawdbot.md](.agent/workflows/update_clawdbot.md) and [FORK-CHANGES.md](FORK-CHANGES.md)."
          gh issue create --repo "${{ github.repository }}" --title "$TITLE" --body "$BODY"
        env:
          GH_TOKEN: ${{ github.token }}
