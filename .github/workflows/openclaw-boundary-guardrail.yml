name: OpenClaw boundary guardrail

on:
  pull_request:

jobs:
  forbid-new-openclaw-mentions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR does not introduce OpenClaw mentions outside legacy paths
        shell: bash
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          set -euo pipefail

          if [ -z "${BASE_REF:-}" ]; then
            echo "::error::Could not determine base branch for PR."
            exit 1
          fi

          git fetch --depth 1 origin "${BASE_REF}"
          DIFF_RANGE="origin/${BASE_REF}...HEAD"

          is_legacy_path() {
            case "$1" in
              dispatch/logs/*|docs/archive/*|real-dispatch-agile-package/10-Appendix/*)
                return 0
                ;;
              *)
                return 1
                ;;
            esac
          }

          has_violation=0

          while IFS= read -r file; do
            if is_legacy_path "$file"; then
              continue
            fi

            added_openclaw=$(git diff --unified=0 "$DIFF_RANGE" -- "$file" | grep -E '^\+[^+].*openclaw' -i || true)
            if [ -n "$added_openclaw" ]; then
              has_violation=1
              echo "::error file=$file::Added OpenClaw mention(s):"
              printf '%s\n' "$added_openclaw"
            fi
          done < <(git diff --name-only --diff-filter=ACMRTUXB "$DIFF_RANGE")

          if [ "$has_violation" -ne 0 ]; then
            echo "::error::This PR introduces OpenClaw mentions outside legacy paths."
            echo "Allowed legacy paths: dispatch/logs/**, docs/archive/**, and real-dispatch-agile-package/10-Appendix/** only."
            exit 1
          fi

          echo "OpenClaw boundary guardrail: OK"
