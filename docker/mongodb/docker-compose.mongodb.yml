# docker-compose.mongodb.yml - MongoDB setup for ClawMongo
# Adapted from github.com/JohnGUnderwood/mdb-community-search
#
# Usage:
#   Full stack (mongod + mongot + vector search):
#     docker compose -f docker/mongodb/docker-compose.mongodb.yml --profile setup run --rm setup-generator
#     docker compose -f docker/mongodb/docker-compose.mongodb.yml --profile fullstack up -d
#
#   Replica set only (transactions, no vector search):
#     docker compose -f docker/mongodb/docker-compose.mongodb.yml --profile replicaset up -d
#
#   Standalone (simplest, no transactions or search):
#     docker compose -f docker/mongodb/docker-compose.mongodb.yml --profile standalone up -d

services:
  # One-time setup: generates keyfile, password files, optional Voyage API key files
  setup-generator:
    image: alpine:latest
    container_name: clawmongo-setup
    volumes:
      - auth-files:/auth
    environment:
      - MONGOT_PASSWORD=${MONGOT_PASSWORD:-mongotPassword}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
    command: >
      sh -c "
        echo 'Setting up ClawMongo security files...';

        if [ ! -f /auth/keyfile ]; then
          echo 'Generating keyfile...';
          apk add --no-cache openssl > /dev/null 2>&1;
          openssl rand -base64 756 > /auth/keyfile;
          chmod 400 /auth/keyfile;
          chown 101:101 /auth/keyfile;
          echo 'Keyfile generated successfully';
        else
          echo 'Keyfile already exists, skipping';
        fi;

        echo -n \"$$MONGOT_PASSWORD\" > /auth/passwordFile;
        chmod 600 /auth/passwordFile;
        chown 101:101 /auth/passwordFile;
        echo 'Password file created';

        if [ -n \"$$VOYAGE_API_KEY\" ] && [ \"$$VOYAGE_API_KEY\" != '' ]; then
          echo 'Creating Voyage API key files...';
          echo -n \"$$VOYAGE_API_KEY\" > /auth/voyage-api-query-key;
          echo -n \"$$VOYAGE_API_KEY\" > /auth/voyage-api-indexing-key;
          chmod 600 /auth/voyage-api-query-key /auth/voyage-api-indexing-key;
          chown 101:101 /auth/voyage-api-query-key /auth/voyage-api-indexing-key;
          echo 'Voyage API key files created';
        else
          echo 'No VOYAGE_API_KEY provided, skipping auto-embedding setup';
        fi;
        echo 'Setup complete.';
      "
    restart: "no"
    profiles:
      - setup

  # Tier 1: Standalone MongoDB (simplest - no transactions, no search)
  mongod-standalone:
    image: mongodb/mongodb-community-server:latest
    container_name: clawmongo-mongod-standalone
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    volumes:
      - mongod_standalone_data:/data/db
    profiles:
      - standalone
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Tier 2 & 3: MongoDB with replica set (used by both replicaset and fullstack profiles)
  mongod:
    image: mongodb/mongodb-community-server:latest
    container_name: clawmongo-mongod
    environment:
      MONGODB_INITDB_ROOT_USERNAME: admin
      MONGODB_INITDB_ROOT_PASSWORD: ${ADMIN_PASSWORD:-admin}
      MONGOT_PASSWORD: ${MONGOT_PASSWORD:-mongotPassword}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin}
    command: >-
      mongod
      --config /etc/mongod.conf
      --replSetMember=clawmongo-mongod.clawmongo-net:27017
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    volumes:
      - mongod_data:/data/db
      - mongod_configdb:/data/configdb
      - ./mongod.conf:/etc/mongod.conf:ro
      - auth-files:/auth
      - ./init-mongo.sh:/docker-entrypoint-initdb.d/init-mongo.sh:ro
    networks:
      - clawmongo-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    profiles:
      - replicaset
      - fullstack

  # Tier 3: mongot search engine (fullstack only)
  mongot:
    image: mongodb/mongodb-community-search:latest
    container_name: clawmongo-mongot
    ports:
      - "${MONGOT_GRPC_PORT:-27028}:27028"
      - "${MONGOT_HEALTH_PORT:-8080}:8080"
      - "${MONGOT_METRICS_PORT:-9946}:9946"
    volumes:
      - mongot_data:/data/mongot
      - ./mongot.conf:/mongot-community/config.default.yml:ro
      - auth-files:/auth
    networks:
      - clawmongo-net
    depends_on:
      mongod:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://clawmongo-mongot.clawmongo-net:9946/metrics",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    profiles:
      - fullstack

volumes:
  mongod_standalone_data:
  mongod_data:
  mongod_configdb:
  mongot_data:
  auth-files:

networks:
  clawmongo-net:
    name: clawmongo-net
    driver: bridge
