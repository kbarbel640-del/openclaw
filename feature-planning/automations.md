# Automations

Automations allow you to schedule recurring tasks like syncing forked repositories, running custom scripts, or triggering webhooks. The automations system is built on the same infrastructure as the Cron scheduler and provides similar functionality with additional features tailored for automation workflows.

## Configuration

Automations are configured in your `clawdbrain.yaml` file under the `automations` section:

```yaml
automations:
  # Enable or disable automations (default: true)
  enabled: true

  # Custom store path for automation data (optional)
  store: /path/to/automations.json

  # Custom directory for artifact storage (optional)
  artifactsDir: /path/to/artifacts

  # Maximum concurrent automation runs (default: 3)
  maxConcurrentRuns: 3

  # Maximum run duration before cancellation (default: 1 hour)
  maxRunDurationMs: 3600000

  # How many days of run history to retain (default: 30)
  historyRetentionDays: 30

  # Maximum run records per automation (default: 100)
  historyMaxRunsPerAutomation: 100
```

## Automation Types

### Smart Sync Fork

Automatically sync a forked repository with its upstream and create pull requests:

```yaml
type: smart-sync-fork
config:
  forkRepoUrl: https://github.com/yourusername/fork.git
  upstreamRepoUrl: https://github.com/original/repo.git
  forkBranch: main
  upstreamBranch: main
  syncStrategy: merge
  createPr: true
  prTitle: "Sync from upstream"
  prBody: "Automated sync from upstream repository"
```

### Custom Script

Run a custom script or command on a schedule:

```yaml
type: custom-script
config:
  script: /path/to/script.sh
  args:
    - "--verbose"
    - "--output=/tmp/output"
  workingDirectory: /path/to/working/dir
  timeoutMs: 300000
  environment:
    VAR1: value1
    VAR2: value2
```

### Webhook

Trigger an external webhook URL:

```yaml
type: webhook
config:
  url: https://example.com/webhook
  method: POST
  headers:
    Authorization: "Bearer token123"
    Content-Type: "application/json"
  body:
    key: "value"
  retryPolicy:
    maxRetries: 3
    backoffMs: 1000
```

## Scheduling

Automations support three schedule types:

### At (One-time)

Run once at a specific time:

```yaml
schedule:
  type: at
  atMs: 1704067200000 # Unix timestamp in milliseconds
```

### Every (Recurring)

Run at regular intervals:

```yaml
schedule:
  type: every
  everyMs: 3600000 # Run every hour (in milliseconds)
  anchorMs: 1704000000000 # Optional anchor time for alignment
```

### Cron (Advanced)

Use cron expressions for complex scheduling:

```yaml
schedule:
  type: cron
  expr: "0 0 * * *" # Daily at midnight
  tz: "America/New_York" # Optional timezone
```

## CLI Commands

### List Automations

```bash
clawdbrain automations list
clawdbrain automations ls
```

### View Run History

```bash
clawdbrain automations history <automation-id>
clawdbrain automations history <automation-id> --limit 100
```

## Web UI

Automations can also be managed through the Web UI:

- View all automations and their status
- Create, edit, and delete automations
- View detailed run history with artifacts
- Monitor progress in real-time
- Download artifacts generated by automation runs

## Artifacts

Automations can generate artifacts (files, reports, logs) during execution. These are stored locally and can be downloaded through the Web UI or CLI. Artifacts are automatically cleaned up based on the retention policy.

## Execution

- **Isolated Execution**: Each automation runs in an isolated session to prevent interference
- **Concurrency**: By default, up to 3 automations can run concurrently (configurable)
- **Timeout**: Runs that exceed the configured duration are automatically cancelled
- **Retry Policies**: Failed automation runs are logged but not automatically retried

## Monitoring

- **SSE Events**: Real-time updates are sent over Server-Sent Events for automation lifecycle events
- **Run History**: Detailed history of all runs with status, duration, artifacts, and error information
- **Status Indicators**: Each automation shows its current status (active, suspended, error)

## Best Practices

1. **Start Simple**: Begin with custom-script automations before moving to complex smart-sync-fork workflows
2. **Set Appropriate Intervals**: Use reasonable intervals to avoid resource exhaustion
3. **Monitor Runs**: Regularly check run history to catch issues early
4. **Handle Errors**: Include error handling in your scripts to provide meaningful error messages
5. **Test Locally**: Test scripts manually before scheduling them as automations
6. **Use Timeouts**: Always set appropriate timeouts for automation runs
7. **Resource Limits**: Be mindful of system resources when scheduling multiple automations

## Troubleshooting

### Automation Not Running

1. Check if automation is enabled: `clawdbrain automations list`
2. Verify the schedule is correct
3. Check gateway logs for errors: `clawdbrain logs tail --gateway`
4. Ensure the gateway is running: `clawdbrain status`

### Run Failed

1. View run history: `clawdbrain automations history <id>`
2. Check error details in the run output
3. Verify script permissions and paths
4. Check system resources (disk space, memory)

### High Memory Usage

1. Reduce `maxConcurrentRuns` in config
2. Increase history cleanup interval
3. Check for runaway automation runs
4. Review artifact storage usage

## Examples

### Daily Database Backup

```yaml
name: "Daily Database Backup"
type: custom-script
schedule:
  type: cron
  expr: "0 2 * * *" # 2 AM daily
config:
  script: /usr/local/bin/backup-db.sh
  timeoutMs: 600000 # 10 minutes
```

### Hourly Health Check

```yaml
name: "Service Health Check"
type: webhook
schedule:
  type: every
  everyMs: 3600000 # Every hour
config:
  url: https://monitoring.example.com/healthcheck
  method: POST
```

### Weekly Report Generation

```yaml
name: "Weekly Report"
type: custom-script
schedule:
  type: cron
  expr: "0 9 * * 1" # 9 AM every Monday
config:
  script: /usr/local/bin/generate-report.sh
  workingDirectory: /var/reports
```

## See Also

- [Cron Scheduler](/cli/cron)
- [Web UI](/ui/overview)
- [Configuration](/configuration)
